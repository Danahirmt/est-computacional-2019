<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>10.10 Modelos jerárquicos | Estadística Computacional</title>
  <meta name="description" content="Curso de estadística computacional, Maestría en Ciencia de Datos, ITAM 2019." />
  <meta name="generator" content="bookdown 0.15.1 and GitBook 2.6.7" />

  <meta property="og:title" content="10.10 Modelos jerárquicos | Estadística Computacional" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Curso de estadística computacional, Maestría en Ciencia de Datos, ITAM 2019." />
  <meta name="github-repo" content="tereom/est-computacional-2019" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="10.10 Modelos jerárquicos | Estadística Computacional" />
  
  <meta name="twitter:description" content="Curso de estadística computacional, Maestría en Ciencia de Datos, ITAM 2019." />
  

<meta name="author" content="María Teresa Ortiz" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="diagnósticos-generales.html"/>
<link rel="next" href="inicialesy-reparametrización.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<script src="libs/d3-3.5.6/d3.min.js"></script>
<link href="libs/profvis-0.3.6/profvis.css" rel="stylesheet" />
<script src="libs/profvis-0.3.6/profvis.js"></script>
<link href="libs/highlight-6.2.0/textmate.css" rel="stylesheet" />
<script src="libs/highlight-6.2.0/highlight.js"></script>
<script src="libs/profvis-binding-0.3.6/profvis.js"></script>
<script src="libs/plotly-binding-4.9.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.49.4/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.49.4/plotly-latest.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/toc.css" type="text/css" />
<link rel="stylesheet" href="css/font-awesome.min.css" type="text/css" />
<link rel="stylesheet" href="css/cajas.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Estadística Computacional</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Información del curso</a><ul>
<li class="chapter" data-level="" data-path="temario.html"><a href="temario.html"><i class="fa fa-check"></i>Temario</a><ul>
<li class="chapter" data-level="" data-path="temario.html"><a href="temario.html#calificación"><i class="fa fa-check"></i>Calificación</a></li>
<li class="chapter" data-level="" data-path="temario.html"><a href="temario.html#software"><i class="fa fa-check"></i>Software</a></li>
<li class="chapter" data-level="" data-path="temario.html"><a href="temario.html#otros-recursos"><i class="fa fa-check"></i>Otros recursos</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="noticias.html"><a href="noticias.html"><i class="fa fa-check"></i>Noticias</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="principios-visualización.html"><a href="principios-visualización.html"><i class="fa fa-check"></i><b>1</b> Principios visualización</a><ul>
<li class="chapter" data-level="1.1" data-path="introducción.html"><a href="introducción.html"><i class="fa fa-check"></i><b>1.1</b> Introducción</a><ul>
<li class="chapter" data-level="" data-path="introducción.html"><a href="introducción.html#visualización-de-datos-en-la-estadística"><i class="fa fa-check"></i>Visualización de datos en la estadística</a></li>
<li class="chapter" data-level="" data-path="introducción.html"><a href="introducción.html#visualización-popular-de-datos"><i class="fa fa-check"></i>Visualización popular de datos</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="teoría-de-visualización-de-datos.html"><a href="teoría-de-visualización-de-datos.html"><i class="fa fa-check"></i><b>1.2</b> Teoría de visualización de datos</a></li>
<li class="chapter" data-level="1.3" data-path="factor-de-engaño-y-chartjunk.html"><a href="factor-de-engaño-y-chartjunk.html"><i class="fa fa-check"></i><b>1.3</b> Factor de engaño y Chartjunk</a></li>
<li class="chapter" data-level="1.4" data-path="pequeños-múltiplos-y-densidad-gráfica.html"><a href="pequeños-múltiplos-y-densidad-gráfica.html"><i class="fa fa-check"></i><b>1.4</b> Pequeños múltiplos y densidad gráfica</a></li>
<li class="chapter" data-level="1.5" data-path="tinta-de-datos.html"><a href="tinta-de-datos.html"><i class="fa fa-check"></i><b>1.5</b> Tinta de datos</a></li>
<li class="chapter" data-level="1.6" data-path="decoración.html"><a href="decoración.html"><i class="fa fa-check"></i><b>1.6</b> Decoración</a></li>
<li class="chapter" data-level="1.7" data-path="percepción-de-escala.html"><a href="percepción-de-escala.html"><i class="fa fa-check"></i><b>1.7</b> Percepción de escala</a></li>
<li class="chapter" data-level="1.8" data-path="ejemplos-gráfica-de-minard.html"><a href="ejemplos-gráfica-de-minard.html"><i class="fa fa-check"></i><b>1.8</b> Ejemplos: gráfica de Minard</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introducción-a-r-y-al-paquete-ggplot2.html"><a href="introducción-a-r-y-al-paquete-ggplot2.html"><i class="fa fa-check"></i><b>2</b> Introducción a R y al paquete ggplot2</a><ul>
<li class="chapter" data-level="2.1" data-path="r-primeros-pasos.html"><a href="r-primeros-pasos.html"><i class="fa fa-check"></i><b>2.1</b> R: primeros pasos</a><ul>
<li class="chapter" data-level="" data-path="r-primeros-pasos.html"><a href="r-primeros-pasos.html#r-en-análisis-de-datos"><i class="fa fa-check"></i>R en análisis de datos</a></li>
<li class="chapter" data-level="" data-path="r-primeros-pasos.html"><a href="r-primeros-pasos.html#paquetes-y-el-tidyverse"><i class="fa fa-check"></i>Paquetes y el Tidyverse</a></li>
<li class="chapter" data-level="" data-path="r-primeros-pasos.html"><a href="r-primeros-pasos.html#recursos"><i class="fa fa-check"></i>Recursos</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="visualización-con-ggplot2.html"><a href="visualización-con-ggplot2.html"><i class="fa fa-check"></i><b>2.2</b> Visualización con ggplot2</a><ul>
<li class="chapter" data-level="" data-path="visualización-con-ggplot2.html"><a href="visualización-con-ggplot2.html#recursos-1"><i class="fa fa-check"></i>Recursos</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="manipulación-y-agrupación-de-datos.html"><a href="manipulación-y-agrupación-de-datos.html"><i class="fa fa-check"></i><b>3</b> Manipulación y agrupación de datos</a><ul>
<li class="chapter" data-level="3.1" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html"><i class="fa fa-check"></i><b>3.1</b> Transformación de datos</a><ul>
<li class="chapter" data-level="" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html#datos"><i class="fa fa-check"></i>Datos</a></li>
<li class="chapter" data-level="" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html#filtrar"><i class="fa fa-check"></i>Filtrar</a></li>
<li class="chapter" data-level="" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html#seleccionar"><i class="fa fa-check"></i>Seleccionar</a></li>
<li class="chapter" data-level="" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html#ordenar"><i class="fa fa-check"></i>Ordenar</a></li>
<li class="chapter" data-level="" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html#mutar"><i class="fa fa-check"></i>Mutar</a></li>
<li class="chapter" data-level="" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html#summarise-y-resúmenes-por-grupo"><i class="fa fa-check"></i>Summarise y resúmenes por grupo</a></li>
<li class="chapter" data-level="" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html#variables-por-grupo"><i class="fa fa-check"></i>Variables por grupo</a></li>
<li class="chapter" data-level="" data-path="transformación-de-datos.html"><a href="transformación-de-datos.html#verbos-de-dos-tablas"><i class="fa fa-check"></i>Verbos de dos tablas</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="datos-limpios.html"><a href="datos-limpios.html"><i class="fa fa-check"></i><b>3.2</b> Datos limpios</a><ul>
<li class="chapter" data-level="" data-path="datos-limpios.html"><a href="datos-limpios.html#limpieza-bases-de-datos"><i class="fa fa-check"></i>Limpieza bases de datos</a></li>
<li class="chapter" data-level="" data-path="datos-limpios.html"><a href="datos-limpios.html#los-encabezados-de-las-columanas-son-valores"><i class="fa fa-check"></i>Los encabezados de las columanas son valores</a></li>
<li class="chapter" data-level="" data-path="datos-limpios.html"><a href="datos-limpios.html#una-columna-asociada-a-más-de-una-variable"><i class="fa fa-check"></i>Una columna asociada a más de una variable</a></li>
<li class="chapter" data-level="" data-path="datos-limpios.html"><a href="datos-limpios.html#variables-almacenadas-en-filas-y-columnas"><i class="fa fa-check"></i>Variables almacenadas en filas y columnas</a></li>
<li class="chapter" data-level="" data-path="datos-limpios.html"><a href="datos-limpios.html#una-misma-unidad-observacional-está-almacenada-en-múltiples-tablas"><i class="fa fa-check"></i>Una misma unidad observacional está almacenada en múltiples tablas</a></li>
<li class="chapter" data-level="" data-path="datos-limpios.html"><a href="datos-limpios.html#otras-consideraciones"><i class="fa fa-check"></i>Otras consideraciones</a></li>
<li class="chapter" data-level="" data-path="datos-limpios.html"><a href="datos-limpios.html#recursos-adicionales"><i class="fa fa-check"></i>Recursos adicionales</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="temas-selectos-de-r.html"><a href="temas-selectos-de-r.html"><i class="fa fa-check"></i><b>4</b> Temas selectos de R</a><ul>
<li class="chapter" data-level="4.1" data-path="funciones-e-iteración.html"><a href="funciones-e-iteración.html"><i class="fa fa-check"></i><b>4.1</b> Funciones e iteración</a><ul>
<li class="chapter" data-level="" data-path="funciones-e-iteración.html"><a href="funciones-e-iteración.html#funciones"><i class="fa fa-check"></i>Funciones</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="vectores.html"><a href="vectores.html"><i class="fa fa-check"></i><b>4.2</b> Vectores</a><ul>
<li class="chapter" data-level="" data-path="vectores.html"><a href="vectores.html#propiedades"><i class="fa fa-check"></i>Propiedades</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="iteración.html"><a href="iteración.html"><i class="fa fa-check"></i><b>4.3</b> Iteración</a><ul>
<li class="chapter" data-level="" data-path="iteración.html"><a href="iteración.html#ciclos-for"><i class="fa fa-check"></i>Ciclos for</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="rendimiento-en-r.html"><a href="rendimiento-en-r.html"><i class="fa fa-check"></i><b>4.4</b> Rendimiento en R</a><ul>
<li class="chapter" data-level="" data-path="rendimiento-en-r.html"><a href="rendimiento-en-r.html#diagnosticar"><i class="fa fa-check"></i>Diagnosticar</a></li>
<li class="chapter" data-level="" data-path="rendimiento-en-r.html"><a href="rendimiento-en-r.html#estrategias-para-mejorar-desempeño"><i class="fa fa-check"></i>Estrategias para mejorar desempeño</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="lecturas-y-recursos-recomendados-de-r.html"><a href="lecturas-y-recursos-recomendados-de-r.html"><i class="fa fa-check"></i><b>4.5</b> Lecturas y recursos recomendados de R</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="introducción-a-cálculo-de-probabilidades.html"><a href="introducción-a-cálculo-de-probabilidades.html"><i class="fa fa-check"></i><b>5</b> Introducción a Cálculo de Probabilidades</a><ul>
<li class="chapter" data-level="5.1" data-path="probabilidad-como-extensión-de-proporción.html"><a href="probabilidad-como-extensión-de-proporción.html"><i class="fa fa-check"></i><b>5.1</b> Probabilidad como extensión de proporción</a></li>
<li class="chapter" data-level="5.2" data-path="interpretación-frecuentista-de-probabilidad.html"><a href="interpretación-frecuentista-de-probabilidad.html"><i class="fa fa-check"></i><b>5.2</b> Interpretación frecuentista de probabilidad</a><ul>
<li class="chapter" data-level="" data-path="interpretación-frecuentista-de-probabilidad.html"><a href="interpretación-frecuentista-de-probabilidad.html#resultados-empíricos-acerca-de-frecuencias-relativas"><i class="fa fa-check"></i>Resultados empíricos acerca de frecuencias relativas</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="simulación-para-el-cálculo-de-probabilidades.html"><a href="simulación-para-el-cálculo-de-probabilidades.html"><i class="fa fa-check"></i><b>5.3</b> Simulación para el cálculo de probabilidades</a></li>
<li class="chapter" data-level="5.4" data-path="modelos-de-probabilidad-definición-general.html"><a href="modelos-de-probabilidad-definición-general.html"><i class="fa fa-check"></i><b>5.4</b> Modelos de probabilidad (definición general)</a><ul>
<li class="chapter" data-level="5.4.1" data-path="modelos-de-probabilidad-definición-general.html"><a href="modelos-de-probabilidad-definición-general.html#espacios-discretos"><i class="fa fa-check"></i><b>5.4.1</b> Espacios discretos</a></li>
<li class="chapter" data-level="5.4.2" data-path="modelos-de-probabilidad-definición-general.html"><a href="modelos-de-probabilidad-definición-general.html#espacios-continuos"><i class="fa fa-check"></i><b>5.4.2</b> Espacios continuos</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="probabilidad-definición-matemática.html"><a href="probabilidad-definición-matemática.html"><i class="fa fa-check"></i><b>5.5</b> Probabilidad: definición matemática</a><ul>
<li class="chapter" data-level="" data-path="probabilidad-definición-matemática.html"><a href="probabilidad-definición-matemática.html#propiedades-de-la-función-de-probabilidad"><i class="fa fa-check"></i>Propiedades de la función de probabilidad:</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="variables-aleatorias.html"><a href="variables-aleatorias.html"><i class="fa fa-check"></i><b>5.6</b> Variables aleatorias</a><ul>
<li class="chapter" data-level="" data-path="variables-aleatorias.html"><a href="variables-aleatorias.html#distribución-de-probabilidad"><i class="fa fa-check"></i>Distribución de probabilidad</a></li>
<li class="chapter" data-level="" data-path="variables-aleatorias.html"><a href="variables-aleatorias.html#variables-aleatorias-continuas"><i class="fa fa-check"></i>Variables aleatorias continuas</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="bootstrap-no-paramétrico.html"><a href="bootstrap-no-paramétrico.html"><i class="fa fa-check"></i><b>6</b> Bootstrap no paramétrico</a><ul>
<li class="chapter" data-level="6.1" data-path="el-principio-del-plug-in.html"><a href="el-principio-del-plug-in.html"><i class="fa fa-check"></i><b>6.1</b> El principio del plug-in</a><ul>
<li class="chapter" data-level="" data-path="el-principio-del-plug-in.html"><a href="el-principio-del-plug-in.html#muestras-aleatorias"><i class="fa fa-check"></i>Muestras aleatorias</a></li>
<li class="chapter" data-level="" data-path="el-principio-del-plug-in.html"><a href="el-principio-del-plug-in.html#función-de-distribución-empírica"><i class="fa fa-check"></i>Función de distribución empírica</a></li>
<li class="chapter" data-level="" data-path="el-principio-del-plug-in.html"><a href="el-principio-del-plug-in.html#parámetros-y-estadísticas"><i class="fa fa-check"></i>Parámetros y estadísticas</a></li>
<li class="chapter" data-level="" data-path="el-principio-del-plug-in.html"><a href="el-principio-del-plug-in.html#distribuciones-muestrales-y-errores-estándar"><i class="fa fa-check"></i>Distribuciones muestrales y errores estándar</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="el-estimador-bootstrap-del-error-estándar.html"><a href="el-estimador-bootstrap-del-error-estándar.html"><i class="fa fa-check"></i><b>6.2</b> El estimador bootstrap del error estándar</a><ul>
<li class="chapter" data-level="" data-path="el-estimador-bootstrap-del-error-estándar.html"><a href="el-estimador-bootstrap-del-error-estándar.html#variación-en-distribuciones-bootstrap"><i class="fa fa-check"></i>Variación en distribuciones bootstrap</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="intervalos-de-confianza.html"><a href="intervalos-de-confianza.html"><i class="fa fa-check"></i><b>6.3</b> Intervalos de confianza</a></li>
<li class="chapter" data-level="6.4" data-path="más-alla-de-muestras-aleatorias-simples.html"><a href="más-alla-de-muestras-aleatorias-simples.html"><i class="fa fa-check"></i><b>6.4</b> Más alla de muestras aleatorias simples</a></li>
<li class="chapter" data-level="6.5" data-path="bootstrap-en-r.html"><a href="bootstrap-en-r.html"><i class="fa fa-check"></i><b>6.5</b> Bootstrap en R</a></li>
<li class="chapter" data-level="6.6" data-path="conclusiones-y-observaciones.html"><a href="conclusiones-y-observaciones.html"><i class="fa fa-check"></i><b>6.6</b> Conclusiones y observaciones</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="teoría-básica-de-simulación.html"><a href="teoría-básica-de-simulación.html"><i class="fa fa-check"></i><b>7</b> Teoría básica de simulación</a><ul>
<li class="chapter" data-level="7.1" data-path="números-pseudoaleatorios.html"><a href="números-pseudoaleatorios.html"><i class="fa fa-check"></i><b>7.1</b> Números pseudoaleatorios</a><ul>
<li class="chapter" data-level="" data-path="números-pseudoaleatorios.html"><a href="números-pseudoaleatorios.html#generadores-congruenciales-y-mersenne-twister"><i class="fa fa-check"></i>Generadores congruenciales y Mersenne-Twister</a></li>
<li class="chapter" data-level="" data-path="números-pseudoaleatorios.html"><a href="números-pseudoaleatorios.html#pruebas-de-aleatoriedad"><i class="fa fa-check"></i>Pruebas de aleatoriedad</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="variables-aleatorias-1.html"><a href="variables-aleatorias-1.html"><i class="fa fa-check"></i><b>7.2</b> Variables aleatorias</a><ul>
<li class="chapter" data-level="" data-path="variables-aleatorias-1.html"><a href="variables-aleatorias-1.html#familias-discretas-importantes"><i class="fa fa-check"></i>Familias discretas importantes</a></li>
<li class="chapter" data-level="" data-path="variables-aleatorias-1.html"><a href="variables-aleatorias-1.html#familias-continuas-importantes"><i class="fa fa-check"></i>Familias Continuas importantes</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="simulación-de-variables-aleatorias.html"><a href="simulación-de-variables-aleatorias.html"><i class="fa fa-check"></i><b>7.3</b> Simulación de variables aleatorias</a><ul>
<li class="chapter" data-level="" data-path="simulación-de-variables-aleatorias.html"><a href="simulación-de-variables-aleatorias.html#variables-aletaorias-discretas"><i class="fa fa-check"></i>Variables aletaorias discretas</a></li>
<li class="chapter" data-level="" data-path="simulación-de-variables-aleatorias.html"><a href="simulación-de-variables-aleatorias.html#aceptación-y-rechazo"><i class="fa fa-check"></i>Aceptación y rechazo</a></li>
<li class="chapter" data-level="" data-path="simulación-de-variables-aleatorias.html"><a href="simulación-de-variables-aleatorias.html#variables-aleatorias-continuas-2"><i class="fa fa-check"></i>Variables aleatorias continuas</a></li>
<li class="chapter" data-level="" data-path="simulación-de-variables-aleatorias.html"><a href="simulación-de-variables-aleatorias.html#aceptación-y-rechazo-1"><i class="fa fa-check"></i>Aceptación y rechazo</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="simulación-de-modelos.html"><a href="simulación-de-modelos.html"><i class="fa fa-check"></i><b>8</b> Simulación de modelos</a><ul>
<li class="chapter" data-level="" data-path="simulación-de-modelos.html"><a href="simulación-de-modelos.html#para-qué-simular-de-un-modelo"><i class="fa fa-check"></i>¿Para qué simular de un modelo?</a></li>
<li class="chapter" data-level="8.1" data-path="distribuciones-multivariadas.html"><a href="distribuciones-multivariadas.html"><i class="fa fa-check"></i><b>8.1</b> Distribuciones multivariadas</a><ul>
<li class="chapter" data-level="" data-path="distribuciones-multivariadas.html"><a href="distribuciones-multivariadas.html#regla-de-bayes"><i class="fa fa-check"></i>Regla de Bayes</a></li>
<li class="chapter" data-level="" data-path="distribuciones-multivariadas.html"><a href="distribuciones-multivariadas.html#independencia"><i class="fa fa-check"></i>Independencia</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="modelos-gráficos-y-simulación-predictiva.html"><a href="modelos-gráficos-y-simulación-predictiva.html"><i class="fa fa-check"></i><b>8.2</b> Modelos gráficos y simulación predictiva</a></li>
<li class="chapter" data-level="8.3" data-path="inferencia-visual.html"><a href="inferencia-visual.html"><i class="fa fa-check"></i><b>8.3</b> Inferencia visual</a><ul>
<li class="chapter" data-level="" data-path="inferencia-visual.html"><a href="inferencia-visual.html#inferencia"><i class="fa fa-check"></i>Inferencia</a></li>
<li class="chapter" data-level="" data-path="inferencia-visual.html"><a href="inferencia-visual.html#protocolos-de-inferencia-visual"><i class="fa fa-check"></i>Protocolos de inferencia visual</a></li>
<li class="chapter" data-level="" data-path="inferencia-visual.html"><a href="inferencia-visual.html#pruebas-de-hipótesis-típicas"><i class="fa fa-check"></i>Pruebas de hipótesis típicas</a></li>
<li class="chapter" data-level="" data-path="inferencia-visual.html"><a href="inferencia-visual.html#inferencia-visual-1"><i class="fa fa-check"></i>Inferencia visual</a></li>
<li class="chapter" data-level="" data-path="inferencia-visual.html"><a href="inferencia-visual.html#más-allá-que-permutación"><i class="fa fa-check"></i>Más allá que permutación</a></li>
<li class="chapter" data-level="" data-path="inferencia-visual.html"><a href="inferencia-visual.html#otras-consideraciones-1"><i class="fa fa-check"></i>Otras consideraciones</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="tamaño-de-muestracalculos-de-potencia.html"><a href="tamaño-de-muestracalculos-de-potencia.html"><i class="fa fa-check"></i><b>8.4</b> Tamaño de muestra/calculos de potencia</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="inferencia-paramétrica.html"><a href="inferencia-paramétrica.html"><i class="fa fa-check"></i><b>9</b> Inferencia paramétrica</a><ul>
<li class="chapter" data-level="9.1" data-path="máxima-verosimilitud.html"><a href="máxima-verosimilitud.html"><i class="fa fa-check"></i><b>9.1</b> Máxima verosimilitud</a><ul>
<li class="chapter" data-level="" data-path="máxima-verosimilitud.html"><a href="máxima-verosimilitud.html#propiedades-de-los-estimadores-de-máxima-verosimilitud"><i class="fa fa-check"></i>Propiedades de los estimadores de máxima verosimilitud</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="bootstrap-paramétrico.html"><a href="bootstrap-paramétrico.html"><i class="fa fa-check"></i><b>9.2</b> Bootstrap paramétrico</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="análisis-bayesiano.html"><a href="análisis-bayesiano.html"><i class="fa fa-check"></i><b>10</b> Análisis bayesiano</a><ul>
<li class="chapter" data-level="10.1" data-path="probabilidad-subjetiva.html"><a href="probabilidad-subjetiva.html"><i class="fa fa-check"></i><b>10.1</b> Probabilidad subjetiva</a></li>
<li class="chapter" data-level="10.2" data-path="regla-de-bayes-e-inferencia-bayesiana.html"><a href="regla-de-bayes-e-inferencia-bayesiana.html"><i class="fa fa-check"></i><b>10.2</b> Regla de Bayes e inferencia bayesiana</a><ul>
<li class="chapter" data-level="" data-path="regla-de-bayes-e-inferencia-bayesiana.html"><a href="regla-de-bayes-e-inferencia-bayesiana.html#regla-de-bayes-en-modelos-y-datos"><i class="fa fa-check"></i>Regla de Bayes en modelos y datos</a></li>
<li class="chapter" data-level="" data-path="regla-de-bayes-e-inferencia-bayesiana.html"><a href="regla-de-bayes-e-inferencia-bayesiana.html#objetivos-de-la-inferencia"><i class="fa fa-check"></i>Objetivos de la inferencia</a></li>
<li class="chapter" data-level="" data-path="regla-de-bayes-e-inferencia-bayesiana.html"><a href="regla-de-bayes-e-inferencia-bayesiana.html#cálculo-de-la-distribución-posterior"><i class="fa fa-check"></i>Cálculo de la distribución posterior</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="distribuciones-conjugadas.html"><a href="distribuciones-conjugadas.html"><i class="fa fa-check"></i><b>10.3</b> Distribuciones conjugadas</a><ul>
<li class="chapter" data-level="" data-path="distribuciones-conjugadas.html"><a href="distribuciones-conjugadas.html#ejemplo-bernoulli"><i class="fa fa-check"></i>Ejemplo: Bernoulli</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="aproximación-por-cuadrícula.html"><a href="aproximación-por-cuadrícula.html"><i class="fa fa-check"></i><b>10.4</b> Aproximación por cuadrícula</a></li>
<li class="chapter" data-level="10.5" data-path="mcmc.html"><a href="mcmc.html"><i class="fa fa-check"></i><b>10.5</b> MCMC</a><ul>
<li class="chapter" data-level="" data-path="mcmc.html"><a href="mcmc.html#introducción-metrópolis"><i class="fa fa-check"></i>Introducción Metrópolis</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="metrópolis.html"><a href="metrópolis.html"><i class="fa fa-check"></i><b>10.6</b> Metrópolis</a><ul>
<li class="chapter" data-level="" data-path="metrópolis.html"><a href="metrópolis.html#inferencia-de-dos-proporciones-binomiales"><i class="fa fa-check"></i>Inferencia de dos proporciones binomiales</a></li>
</ul></li>
<li class="chapter" data-level="10.7" data-path="muestreador-de-gibbs.html"><a href="muestreador-de-gibbs.html"><i class="fa fa-check"></i><b>10.7</b> Muestreador de Gibbs</a><ul>
<li class="chapter" data-level="" data-path="muestreador-de-gibbs.html"><a href="muestreador-de-gibbs.html#conclusiones-y-observaciones-metrópolis-y-gibbs"><i class="fa fa-check"></i>Conclusiones y observaciones Metrópolis y Gibbs</a></li>
</ul></li>
<li class="chapter" data-level="10.8" data-path="hmc-y-stan.html"><a href="hmc-y-stan.html"><i class="fa fa-check"></i><b>10.8</b> HMC y Stan</a><ul>
<li class="chapter" data-level="" data-path="hmc-y-stan.html"><a href="hmc-y-stan.html#muestreo-hmc"><i class="fa fa-check"></i>Muestreo HMC</a></li>
<li class="chapter" data-level="" data-path="hmc-y-stan.html"><a href="hmc-y-stan.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="10.9" data-path="diagnósticos-generales.html"><a href="diagnósticos-generales.html"><i class="fa fa-check"></i><b>10.9</b> Diagnósticos generales</a><ul>
<li class="chapter" data-level="" data-path="diagnósticos-generales.html"><a href="diagnósticos-generales.html#recomendaciones-generales"><i class="fa fa-check"></i>Recomendaciones generales</a></li>
</ul></li>
<li class="chapter" data-level="10.10" data-path="modelos-jerárquicos.html"><a href="modelos-jerárquicos.html"><i class="fa fa-check"></i><b>10.10</b> Modelos jerárquicos</a><ul>
<li class="chapter" data-level="" data-path="modelos-jerárquicos.html"><a href="modelos-jerárquicos.html#modelo-jerárquico-una-moneda"><i class="fa fa-check"></i>Modelo jerárquico una moneda</a></li>
<li class="chapter" data-level="" data-path="modelos-jerárquicos.html"><a href="modelos-jerárquicos.html#multiples-monedas-de-una-misma-fábrica"><i class="fa fa-check"></i>Multiples monedas de una misma fábrica</a></li>
<li class="chapter" data-level="" data-path="modelos-jerárquicos.html"><a href="modelos-jerárquicos.html#ejemplo-estimación-de-tasas-de-mortalidad"><i class="fa fa-check"></i>Ejemplo: estimación de tasas de mortalidad</a></li>
</ul></li>
<li class="chapter" data-level="10.11" data-path="inicialesy-reparametrización.html"><a href="inicialesy-reparametrización.html"><i class="fa fa-check"></i><b>10.11</b> Inicialesy Reparametrización</a><ul>
<li class="chapter" data-level="" data-path="inicialesy-reparametrización.html"><a href="inicialesy-reparametrización.html#iniciales-en-stan"><i class="fa fa-check"></i>Iniciales en Stan</a></li>
</ul></li>
<li class="chapter" data-level="10.12" data-path="reparametrización.html"><a href="reparametrización.html"><i class="fa fa-check"></i><b>10.12</b> Reparametrización</a><ul>
<li class="chapter" data-level="" data-path="reparametrización.html"><a href="reparametrización.html#ejemplo-el-embudo-de-neal"><i class="fa fa-check"></i>Ejemplo: El embudo de Neal</a></li>
<li class="chapter" data-level="" data-path="reparametrización.html"><a href="reparametrización.html#modelos-jerárquicos-y-parametrización-no-centrada"><i class="fa fa-check"></i>Modelos jerárquicos y parametrización no centrada</a></li>
</ul></li>
<li class="chapter" data-level="10.13" data-path="recursos-de-stan-y-paquetes-con-r.html"><a href="recursos-de-stan-y-paquetes-con-r.html"><i class="fa fa-check"></i><b>10.13</b> Recursos de Stan y paquetes con R</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tareas.html"><a href="tareas.html"><i class="fa fa-check"></i>Tareas</a><ul>
<li class="chapter" data-level="" data-path="instalación-y-visualización.html"><a href="instalación-y-visualización.html"><i class="fa fa-check"></i>1. Instalación y visualización</a></li>
<li class="chapter" data-level="" data-path="transformación-de-datos-1.html"><a href="transformación-de-datos-1.html"><i class="fa fa-check"></i>2. Transformación de datos</a></li>
<li class="chapter" data-level="" data-path="unión-de-tablas-y-limpieza-de-datos.html"><a href="unión-de-tablas-y-limpieza-de-datos.html"><i class="fa fa-check"></i>3. Unión de tablas y limpieza de datos</a></li>
<li class="chapter" data-level="" data-path="programación-funcional-y-distribución-muestral.html"><a href="programación-funcional-y-distribución-muestral.html"><i class="fa fa-check"></i>4. Programación funcional y distribución muestral</a><ul>
<li class="chapter" data-level="" data-path="programación-funcional-y-distribución-muestral.html"><a href="programación-funcional-y-distribución-muestral.html#solución-bootstrap"><i class="fa fa-check"></i>Solución + bootstrap</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="bootstrap-conteo.html"><a href="bootstrap-conteo.html"><i class="fa fa-check"></i>5. Bootstrap conteo</a></li>
<li class="chapter" data-level="" data-path="respuesta-ejercicios-clase.html"><a href="respuesta-ejercicios-clase.html"><i class="fa fa-check"></i>Respuesta ejercicios clase</a></li>
<li class="chapter" data-level="" data-path="más-bootstrap.html"><a href="más-bootstrap.html"><i class="fa fa-check"></i>6. Más bootstrap</a></li>
<li class="chapter" data-level="" data-path="simulación-de-variables-aleatorias-1.html"><a href="simulación-de-variables-aleatorias-1.html"><i class="fa fa-check"></i>7. Simulación de variables aleatorias</a></li>
<li class="chapter" data-level="" data-path="distribuciones-multivariada-y-simulación.html"><a href="distribuciones-multivariada-y-simulación.html"><i class="fa fa-check"></i>8. Distribuciones multivariada y simulación</a></li>
<li class="chapter" data-level="" data-path="inferencia-visual-y-simulación-e-modelos.html"><a href="inferencia-visual-y-simulación-e-modelos.html"><i class="fa fa-check"></i>9. Inferencia visual y simulación e modelos</a></li>
<li class="chapter" data-level="" data-path="simulación-muestra-y-bootstrap-paramétrico.html"><a href="simulación-muestra-y-bootstrap-paramétrico.html"><i class="fa fa-check"></i>10. Simulación muestra y bootstrap paramétrico</a></li>
<li class="chapter" data-level="" data-path="familias-conjugadas.html"><a href="familias-conjugadas.html"><i class="fa fa-check"></i>11-Familias conjugadas</a></li>
<li class="chapter" data-level="" data-path="metropolis-1.html"><a href="metropolis-1.html"><i class="fa fa-check"></i>12-Metropolis</a></li>
<li class="chapter" data-level="" data-path="modelos-jerárquicos-1.html"><a href="modelos-jerárquicos-1.html"><i class="fa fa-check"></i>13-Modelos jerárquicos</a></li>
<li class="chapter" data-level="" data-path="final.html"><a href="final.html"><i class="fa fa-check"></i>Final</a><ul>
<li class="chapter" data-level="" data-path="final.html"><a href="final.html#inferencia-gráfica"><i class="fa fa-check"></i>1. Inferencia gráfica</a></li>
<li class="chapter" data-level="" data-path="final.html"><a href="final.html#simulación-para-el-cálculo-de-tamaños-de-muestra"><i class="fa fa-check"></i>2. Simulación para el cálculo de tamaños de muestra</a></li>
<li class="chapter" data-level="" data-path="final.html"><a href="final.html#mcmc-1"><i class="fa fa-check"></i>3. MCMC</a></li>
<li class="chapter" data-level="" data-path="final.html"><a href="final.html#modelos-jerárquicos-y-stan"><i class="fa fa-check"></i>4. Modelos jerárquicos y Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="referencias.html"><a href="referencias.html"><i class="fa fa-check"></i>Referencias</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Publicado con bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estadística Computacional</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="modelos-jerárquicos" class="section level2">
<h2><span class="header-section-number">10.10</span> Modelos jerárquicos</h2>
<p>Los modelos jerárquicos involucran varios parámetros de tal manera que las
creencias de unos de los parámetros dependen de manera significativa de los
valores de otros parámetros. Por ejemplo, consideremos el caso en el que tenemos
varias monedas acuñadas en la misma casa de monedas, es razonable pensar que una
fábrica sesgada a águilas tenderá a producir monedas con sesgo hacia águilas.
La estimación del sesgo de una moneda depende de la estimación del sesgo de la
fábrica que a su vez está influido por los datos de todas las monedas. Veremos
que la estructura de dependenica a lo largo de los parámetros generan
estimaciones mejor informadas para todos los parámetros.</p>
<p>Si pensamos únicamente en dos monedas que provienen de la misma casa de moneda
tenemos:</p>
<ol style="list-style-type: decimal">
<li><p>Conocimientos iniciales de los posibles valores de los parámetros (sesgos
de las monedas).</p></li>
<li><p>Tenemos conocimiento inicial de la dependencia de los parámetros por provenir
de la misma fábrica.</p></li>
</ol>
<p>Cuando observamos lanzamientos de las monedas actualizamos nuestras creencias
relativas a los sesgos de las monedas y también actualizamos nuestras
creencias acerca de la dependencia de los sesgos.</p>
<p>Recordemos el caso de lanzamientos de una moneda, le asignamos una inicial beta,
recordemos que la distribución beta tienen dos parámetors <span class="math inline">\(a\)</span> y <span class="math inline">\(b\)</span>:</p>
<p><span class="math display">\[p(\theta)=\frac{1}{B(a,b)}\theta^{a-1}(1-\theta)^{b-1}\]</span></p>
<p>Con el fin de hacer los parámetros más intuitivos los podemos expresar en
términos de la media <span class="math inline">\(\mu\)</span> y el tamaño de muestra <span class="math inline">\(K\)</span>, donde <span class="math inline">\(\mu\)</span> es la media
de nuestro conocimiento inicial y la confianza está reflejada en el tamaño de
muestra <span class="math inline">\(K\)</span>. Entonces los parámetros correspondientes en la distribución
beta son:</p>
<p><span class="math display">\[a=\mu K, b = (1-\mu)K\]</span></p>
<p>Ahora introducimos el modelo jerárquico. En lugar de especificar un valor
particular para <span class="math inline">\(\mu\)</span>, consideramos que <span class="math inline">\(\mu\)</span> puede tomar distintos valores
(entre <span class="math inline">\(0\)</span> y <span class="math inline">\(1\)</span>), y definimos una distribución de probabilidad sobre esos
valores.
Podemos pensar que esta distribución describe nuestra incertidumbre acerca de la
construcción de la máquina que manufactura las monedas.</p>
<p>Veamos que en el caso de más de una moneda el modelo permite que cada moneda
tenga un sesgo distinto pero ambas
tenderán a tener un sesgo cercano a <span class="math inline">\(\mu\)</span>, algunas aleatoriamente tendrán un
valor de <span class="math inline">\(\theta\)</span> mayor a <span class="math inline">\(\mu\)</span> y otras menor. Entre más grande <span class="math inline">\(K\)</span> mayor será
la consistencia de la acuñadora y los valores <span class="math inline">\(\theta\)</span> serán más cercanos a <span class="math inline">\(\mu\)</span>.
Si observamos varios lanzamientos de una moneda tendremos información tanto de
<span class="math inline">\(\theta\)</span> como de <span class="math inline">\(\mu\)</span>.</p>
<p>Para hacer un análisis bayesiano aún nos hace falta definir la distribución
inicial sobre los parámetros <span class="math inline">\(\mu\)</span>, usemos una distribución Beta:</p>
<p><span class="math display">\[p(\mu)=beta(\mu|A_{\mu}, B_{\mu})\]</span></p>
<p>donde <span class="math inline">\(A_{\mu}\)</span> y <span class="math inline">\(B_{\mu}\)</span> se conocen como hiperparámetros y son constantes. En
este caso, consideramos que <span class="math inline">\(\mu\)</span> se ubica típicamente cerca de
<span class="math inline">\(A_{\mu}/(A_{\mu} + B_{\mu})\)</span> y <span class="math inline">\(K\)</span> se considera constante.</p>
<div id="modelo-jerárquico-una-moneda" class="section level3 unnumbered">
<h3>Modelo jerárquico una moneda</h3>
<p>Recordemos que en el ejemplo de una moneda teníamos que la verosimilitud era
Bernoulli:</p>
<p><span class="math display">\[p(x|theta) = \theta^x(1-\theta)^{1-x}\]</span></p>
<p>Y si utilizamos las iniciales Beta para <span class="math inline">\(\mu\)</span> y <span class="math inline">\(\theta\)</span> como discutimos arriba,
solo nos resta aplicar la regla de Bayes con nuestros dos parámetros
desconocidos <span class="math inline">\(\mu\)</span> y <span class="math inline">\(\theta\)</span>:</p>
<p><span class="math display">\[p(\theta, \mu|x)=\frac{p(x|\theta,\mu)p(\theta,\mu)}{p(x)}\]</span></p>
<p>Hay dos aspectos a considerar en el problema:</p>
<ol style="list-style-type: decimal">
<li><p>La verosimilitud no depende de <span class="math inline">\(\mu\)</span> por lo que
<span class="math display">\[p(x|\theta, \mu)=p(x|\theta)\]</span></p></li>
<li><p>La distribución inicial en el espacio de parámetros bivariado se puede
factorizar:</p></li>
</ol>
<p><span class="math display">\[p(\theta,\mu)=p(\theta|\mu)p(\mu)\]</span></p>
<p>Por lo tanto</p>
<p><span class="math display">\[p(\theta,\mu|x)=\frac{p(x|\theta,\mu)p(\theta,\mu)}{p(x)}\]</span>
<span class="math display">\[=\frac{p(x|\theta)p(\theta|\mu)p(\mu)}{p(x)}\]</span></p>
<p>¿Cuál es el modelo gráfico?</p>
<div id="aproximación-por-cuadrícula-1" class="section level4 unnumbered">
<h4>Aproximación por cuadrícula</h4>
<p>En el caso jerárquico, no se puede derivar la distribución posterior de manera
analítica pero si los parámetros e hiperparámetros toman un número finito de<br />
valores y no hay muchos de ellos, podemos aproximar la posterior usando
aproximación por cuadrícula, utilizar este enfoque en el ejemplo introductorio
ayuda a visualizar el proceso.</p>
<p>A continuación graficamos las distribuciones correspondientes al caso en que
la distribución del hiperparámetro <span class="math inline">\(\mu\)</span> tiene la forma de una distribución
<span class="math inline">\(Beta(2, 2)\)</span>, es decir creemos que la media de la acuñadora <span class="math inline">\(\mu\)</span> es <span class="math inline">\(0.5\)</span>, pero
existe bastante incertidumbre acerca del valor.</p>
<p>La distribución de <span class="math inline">\(\theta\)</span>, esto es la distribución inicial que refleja la
dependencia entre <span class="math inline">\(\theta\)</span> y <span class="math inline">\(\mu\)</span> se expresa por medio de otra distribución
beta, en el ejemplo usamos <span class="math inline">\(K=100\)</span>:</p>
<p><span class="math display">\[\theta|\mu \sim beta(\mu 100, (1-\mu)100)\]</span></p>
<p>Esta inicial expresa un alto grado de certeza que una acuñadora con
hiperparámetro <span class="math inline">\(\mu\)</span> genera monedas con sesgo cercano a <span class="math inline">\(\mu\)</span></p>
<p><img src="09-analisis_bayesiano_files/figure-html/inicial_jer-1.png" width="528" style="display: block; margin: auto;" /></p>
<p>Verosimilitud.</p>
<p><img src="09-analisis_bayesiano_files/figure-html/verosimilitud_jer-1.png" width="259.2" style="display: block; margin: auto;" /></p>
<p>Posterior.</p>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-65-1.png" width="528" style="display: block; margin: auto;" /></p>
<p>Código para el análisis y gráficas de arriba.</p>
<div class="sourceCode" id="cb387"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb387-1" data-line-number="1">A_mu &lt;-<span class="st"> </span><span class="dv">2</span>; B_mu &lt;-<span class="st"> </span><span class="dv">2</span>; K &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb387-2" data-line-number="2"><span class="co"># Distribución inicial conjunta p(theta, mu)</span></a>
<a class="sourceLine" id="cb387-3" data-line-number="3">p_conjunta &lt;-<span class="st"> </span><span class="cf">function</span>(mu, theta, A_mu, B_mu, K){</a>
<a class="sourceLine" id="cb387-4" data-line-number="4">    <span class="co"># marginal p(mu)</span></a>
<a class="sourceLine" id="cb387-5" data-line-number="5">    p_mu &lt;-<span class="st"> </span><span class="kw">dbeta</span>(mu, A_mu, B_mu)</a>
<a class="sourceLine" id="cb387-6" data-line-number="6">    <span class="co"># condicional p(theta | mu)</span></a>
<a class="sourceLine" id="cb387-7" data-line-number="7">    p_theta_mu &lt;-<span class="st"> </span><span class="kw">dbeta</span>(theta, mu <span class="op">*</span><span class="st"> </span>K, (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>mu) <span class="op">*</span><span class="st"> </span>K)</a>
<a class="sourceLine" id="cb387-8" data-line-number="8">    p_mu <span class="op">*</span><span class="st"> </span>p_theta_mu</a>
<a class="sourceLine" id="cb387-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb387-10" data-line-number="10"></a>
<a class="sourceLine" id="cb387-11" data-line-number="11">grid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">theta =</span> <span class="kw">seq</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>, <span class="fl">0.005</span>), </a>
<a class="sourceLine" id="cb387-12" data-line-number="12">    <span class="dt">mu =</span> <span class="kw">seq</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>, <span class="fl">0.005</span>))</a>
<a class="sourceLine" id="cb387-13" data-line-number="13"></a>
<a class="sourceLine" id="cb387-14" data-line-number="14">grid_inicial &lt;-<span class="st"> </span>grid <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-15" data-line-number="15"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">p_inicial =</span> <span class="kw">p_conjunta</span>(mu, theta, A_mu, B_mu, K))</a>
<a class="sourceLine" id="cb387-16" data-line-number="16"></a>
<a class="sourceLine" id="cb387-17" data-line-number="17">plot_conj &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_inicial, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> mu, <span class="dt">z =</span> p_inicial)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-18" data-line-number="18"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="dt">binwidth =</span> <span class="dv">2</span>, <span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-19" data-line-number="19"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-20" data-line-number="20"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-21" data-line-number="21"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">p</span>(theta,mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>) </a>
<a class="sourceLine" id="cb387-22" data-line-number="22"></a>
<a class="sourceLine" id="cb387-23" data-line-number="23">grid_mu &lt;-<span class="st"> </span>grid_inicial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-24" data-line-number="24"><span class="st">    </span><span class="kw">group_by</span>(mu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-25" data-line-number="25"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">p_mu =</span> <span class="kw">sum</span>(p_inicial)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-26" data-line-number="26"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-27" data-line-number="27"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">p_mu =</span> p_mu <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(p_mu))</a>
<a class="sourceLine" id="cb387-28" data-line-number="28"></a>
<a class="sourceLine" id="cb387-29" data-line-number="29">plot_mu &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_mu, <span class="kw">aes</span>(<span class="dt">x =</span> mu, <span class="dt">y =</span> p_mu)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-30" data-line-number="30"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb387-31" data-line-number="31"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(mu)), <span class="dt">x =</span> <span class="kw">expression</span>(mu)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-32" data-line-number="32"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.015</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-33" data-line-number="33"><span class="st">    </span><span class="kw">coord_flip</span>()</a>
<a class="sourceLine" id="cb387-34" data-line-number="34"></a>
<a class="sourceLine" id="cb387-35" data-line-number="35">mus &lt;-<span class="st"> </span><span class="kw">rbeta</span>(<span class="dv">5000</span>, A_mu, B_mu)</a>
<a class="sourceLine" id="cb387-36" data-line-number="36">sims_marg &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">sims =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5000</span>, </a>
<a class="sourceLine" id="cb387-37" data-line-number="37">    <span class="dt">sims_marg =</span> <span class="kw">rbeta</span>(<span class="dv">5000</span>, mus <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>mus) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>))</a>
<a class="sourceLine" id="cb387-38" data-line-number="38"></a>
<a class="sourceLine" id="cb387-39" data-line-number="39">plot_theta &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sims_marg, <span class="kw">aes</span>(<span class="dt">x =</span> sims_marg)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-40" data-line-number="40"><span class="st">    </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-41" data-line-number="41"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(theta)), <span class="dt">x =</span> <span class="kw">expression</span>(theta))</a>
<a class="sourceLine" id="cb387-42" data-line-number="42"></a>
<a class="sourceLine" id="cb387-43" data-line-number="43"><span class="co"># p(theta|mu=0.75)</span></a>
<a class="sourceLine" id="cb387-44" data-line-number="44">sims_cond_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">rbeta</span>(<span class="dv">5000</span>, <span class="fl">0.75</span> <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.75</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb387-45" data-line-number="45"><span class="co"># p(theta|mu=0.25)</span></a>
<a class="sourceLine" id="cb387-46" data-line-number="46">sims_cond_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">rbeta</span>(<span class="dv">5000</span>, <span class="fl">0.25</span> <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.25</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb387-47" data-line-number="47"></a>
<a class="sourceLine" id="cb387-48" data-line-number="48"><span class="co"># marginal = sims_marg</span></a>
<a class="sourceLine" id="cb387-49" data-line-number="49"></a>
<a class="sourceLine" id="cb387-50" data-line-number="50">sims &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">sim =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5000</span>, </a>
<a class="sourceLine" id="cb387-51" data-line-number="51">    <span class="dt">cond_1 =</span> sims_cond_<span class="dv">1</span>, </a>
<a class="sourceLine" id="cb387-52" data-line-number="52">    <span class="dt">cond_2 =</span> sims_cond_<span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-53" data-line-number="53"><span class="st">    </span><span class="kw">gather</span>(dist, values, <span class="op">-</span>sim) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-54" data-line-number="54"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">mu =</span> <span class="kw">ifelse</span>(dist <span class="op">==</span><span class="st"> &quot;cond_1&quot;</span>, <span class="fl">0.75</span>, <span class="fl">0.25</span>))</a>
<a class="sourceLine" id="cb387-55" data-line-number="55"></a>
<a class="sourceLine" id="cb387-56" data-line-number="56"></a>
<a class="sourceLine" id="cb387-57" data-line-number="57">plots_marginales &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sims, <span class="kw">aes</span>(<span class="dt">x =</span> values)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-58" data-line-number="58"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">paste</span>(theta, l, mu))), <span class="dt">x =</span> <span class="kw">expression</span>(theta)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-59" data-line-number="59"><span class="st">    </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-60" data-line-number="60"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>mu, <span class="dt">ncol =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb387-61" data-line-number="61"></a>
<a class="sourceLine" id="cb387-62" data-line-number="62"><span class="kw">grid.arrange</span>(plot_conj, plot_mu, plot_theta, plots_marginales, <span class="dt">ncol =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb387-63" data-line-number="63">likeBern &lt;-<span class="st"> </span><span class="cf">function</span>(z, N){</a>
<a class="sourceLine" id="cb387-64" data-line-number="64">    <span class="cf">function</span>(theta){</a>
<a class="sourceLine" id="cb387-65" data-line-number="65">      theta <span class="op">^</span><span class="st"> </span>z <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>theta) <span class="op">^</span><span class="st"> </span>(N <span class="op">-</span><span class="st"> </span>z)</a>
<a class="sourceLine" id="cb387-66" data-line-number="66">    }</a>
<a class="sourceLine" id="cb387-67" data-line-number="67">}</a>
<a class="sourceLine" id="cb387-68" data-line-number="68"></a>
<a class="sourceLine" id="cb387-69" data-line-number="69"><span class="co"># Valores observados</span></a>
<a class="sourceLine" id="cb387-70" data-line-number="70">z &lt;-<span class="st"> </span><span class="dv">9</span>; N &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb387-71" data-line-number="71">mi_like &lt;-<span class="st"> </span><span class="kw">likeBern</span>(z, N)</a>
<a class="sourceLine" id="cb387-72" data-line-number="72"></a>
<a class="sourceLine" id="cb387-73" data-line-number="73">grid_like &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">x =</span> <span class="kw">seq</span>(<span class="fl">0.01</span>, <span class="dv">1</span>, <span class="fl">0.05</span>), <span class="dt">y =</span> <span class="kw">seq</span>(<span class="fl">0.01</span>, <span class="dv">1</span>, <span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb387-74" data-line-number="74">grid_like &lt;-<span class="st"> </span>grid_like <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-75" data-line-number="75"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">z =</span> <span class="kw">mi_like</span>(x))</a>
<a class="sourceLine" id="cb387-76" data-line-number="76"></a>
<a class="sourceLine" id="cb387-77" data-line-number="77"><span class="kw">ggplot</span>(grid_like, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">z =</span> z)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-78" data-line-number="78"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-79" data-line-number="79"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-80" data-line-number="80"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-81" data-line-number="81"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">L</span>(theta,mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-82" data-line-number="82"><span class="st">    </span><span class="kw">coord_fixed</span>()</a>
<a class="sourceLine" id="cb387-83" data-line-number="83"></a>
<a class="sourceLine" id="cb387-84" data-line-number="84"><span class="co"># cuadrícula</span></a>
<a class="sourceLine" id="cb387-85" data-line-number="85">grid_post &lt;-<span class="st"> </span>grid_inicial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-86" data-line-number="86"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb387-87" data-line-number="87">      <span class="dt">prior =</span> p_inicial <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(p_inicial),</a>
<a class="sourceLine" id="cb387-88" data-line-number="88">      <span class="dt">Like =</span> theta <span class="op">^</span><span class="st"> </span>z <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>theta) <span class="op">^</span><span class="st"> </span>(N <span class="op">-</span><span class="st"> </span>z), <span class="co"># verosimilitud </span></a>
<a class="sourceLine" id="cb387-89" data-line-number="89">      <span class="dt">posterior =</span> (Like <span class="op">*</span><span class="st"> </span>prior) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(Like <span class="op">*</span><span class="st"> </span>prior)</a>
<a class="sourceLine" id="cb387-90" data-line-number="90">    )  </a>
<a class="sourceLine" id="cb387-91" data-line-number="91"></a>
<a class="sourceLine" id="cb387-92" data-line-number="92">post_conj &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_post, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> mu, <span class="dt">z =</span> posterior)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-93" data-line-number="93"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-94" data-line-number="94"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-95" data-line-number="95"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-96" data-line-number="96"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">p</span>(theta,mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>) </a>
<a class="sourceLine" id="cb387-97" data-line-number="97">grid_mu &lt;-<span class="st"> </span>grid_post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-98" data-line-number="98"><span class="st">    </span><span class="kw">group_by</span>(mu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-99" data-line-number="99"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">post_mu =</span> <span class="kw">sum</span>(posterior)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-100" data-line-number="100"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-101" data-line-number="101"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">post_mu =</span> post_mu <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(post_mu))</a>
<a class="sourceLine" id="cb387-102" data-line-number="102"></a>
<a class="sourceLine" id="cb387-103" data-line-number="103">post_mu &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_mu, <span class="kw">aes</span>(<span class="dt">x =</span> mu, <span class="dt">y =</span> post_mu)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-104" data-line-number="104"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb387-105" data-line-number="105"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">paste</span>(mu, l, x))), <span class="dt">x =</span> <span class="kw">expression</span>(mu)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-106" data-line-number="106"><span class="st">    </span><span class="kw">coord_flip</span>()</a>
<a class="sourceLine" id="cb387-107" data-line-number="107"></a>
<a class="sourceLine" id="cb387-108" data-line-number="108">grid_theta &lt;-<span class="st"> </span>grid_post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-109" data-line-number="109"><span class="st">    </span><span class="kw">group_by</span>(theta) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-110" data-line-number="110"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">post_theta =</span> <span class="kw">sum</span>(posterior)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-111" data-line-number="111"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-112" data-line-number="112"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">post_theta =</span> post_theta <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(post_theta))</a>
<a class="sourceLine" id="cb387-113" data-line-number="113"></a>
<a class="sourceLine" id="cb387-114" data-line-number="114">post_theta &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_theta, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> post_theta)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-115" data-line-number="115"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb387-116" data-line-number="116"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">paste</span>(theta, l, x))), <span class="dt">x =</span> <span class="kw">expression</span>(theta))</a>
<a class="sourceLine" id="cb387-117" data-line-number="117"></a>
<a class="sourceLine" id="cb387-118" data-line-number="118">grid_theta_m &lt;-<span class="st"> </span>grid_post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-119" data-line-number="119"><span class="st">    </span><span class="kw">filter</span>(mu <span class="op">==</span><span class="st"> </span><span class="fl">0.75</span> <span class="op">|</span><span class="st"> </span>mu <span class="op">==</span><span class="st"> </span><span class="fl">0.25</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-120" data-line-number="120"><span class="st">    </span><span class="kw">group_by</span>(theta, mu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-121" data-line-number="121"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">post_theta =</span> <span class="kw">sum</span>(posterior)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-122" data-line-number="122"><span class="st">    </span><span class="kw">group_by</span>(mu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb387-123" data-line-number="123"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">post_theta =</span> post_theta <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(post_theta))</a>
<a class="sourceLine" id="cb387-124" data-line-number="124"></a>
<a class="sourceLine" id="cb387-125" data-line-number="125">post_marginales &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_theta_m, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> post_theta)) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-126" data-line-number="126"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb387-127" data-line-number="127"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>mu, <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb387-128" data-line-number="128"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">paste</span>(theta, l, x, mu))), </a>
<a class="sourceLine" id="cb387-129" data-line-number="129">         <span class="dt">x =</span> <span class="kw">expression</span>(theta))</a></code></pre></div>
</div>
</div>
<div id="multiples-monedas-de-una-misma-fábrica" class="section level3 unnumbered">
<h3>Multiples monedas de una misma fábrica</h3>
<p>La sección anterior considera el escenario en que lanzamos una moneda y hacemos
inferencia del parámetro de sesgo <span class="math inline">\(\theta\)</span> y del hiperparámetro <span class="math inline">\(\mu\)</span>. Ahora
consideramos recolectar información de múltiples monedas, si cada moneda tiene
su propio sesgo <span class="math inline">\(\theta_j\)</span> entonces debemos estimar un parámetro distinto para
cada moneda.</p>
<p>Suponemos que todas las monedas provienen de la misma fábrica, esto implica
que tenemos la misma información inicial <span class="math inline">\(\mu\)</span> para todas las monedas. Suponemos
también que cada moneda se acuña de manera independiente, esto es, que
condicional al parámetro <span class="math inline">\(\mu\)</span> los parámetros <span class="math inline">\(\theta_j\)</span> son independientes
en nuestros conocimientos iniciales.</p>
<div id="posterior-vía-aproximación-por-cuadrícula" class="section level4 unnumbered">
<h4>Posterior vía aproximación por cuadrícula</h4>
<p>Supongamosque tenemos dos monedas de la misma fábrica. El objetivo es estimar
los sesgos <span class="math inline">\(\theta_1\)</span>, <span class="math inline">\(\theta_2\)</span> de las dos monedas y estimar simultáneamente
el parámetro <span class="math inline">\(\mu\)</span> correspondiente a la casa de moneda que las fabricó.</p>
<p>Inicial.</p>
<p><img src="09-analisis_bayesiano_files/figure-html/inicial_jer_2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Verosimilitud.</p>
<p><img src="09-analisis_bayesiano_files/figure-html/verosimilitud_jer_2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Posterior.</p>
<p><img src="09-analisis_bayesiano_files/figure-html/posterior_jer_2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Y el código para el análisis y gráficas de arriba.</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb388-1" data-line-number="1">A_mu &lt;-<span class="st"> </span><span class="dv">2</span>; B_mu &lt;-<span class="st"> </span><span class="dv">2</span>; K &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb388-2" data-line-number="2"></a>
<a class="sourceLine" id="cb388-3" data-line-number="3"><span class="co"># Distribución inicial p(theta, mu)</span></a>
<a class="sourceLine" id="cb388-4" data-line-number="4">p_conjunta &lt;-<span class="st"> </span><span class="cf">function</span>(mu, theta, A_mu, B_mu, K){</a>
<a class="sourceLine" id="cb388-5" data-line-number="5">    <span class="co"># marginal p(mu)</span></a>
<a class="sourceLine" id="cb388-6" data-line-number="6">    p_mu &lt;-<span class="st"> </span><span class="kw">dbeta</span>(mu, A_mu, B_mu)</a>
<a class="sourceLine" id="cb388-7" data-line-number="7">    <span class="co"># condicional p(theta | mu)</span></a>
<a class="sourceLine" id="cb388-8" data-line-number="8">    p_theta_mu &lt;-<span class="st"> </span><span class="kw">dbeta</span>(theta, mu <span class="op">*</span><span class="st"> </span>K, (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>mu) <span class="op">*</span><span class="st"> </span>K)</a>
<a class="sourceLine" id="cb388-9" data-line-number="9">    p_mu <span class="op">*</span><span class="st"> </span>p_theta_mu</a>
<a class="sourceLine" id="cb388-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb388-11" data-line-number="11"></a>
<a class="sourceLine" id="cb388-12" data-line-number="12">grid_inicial &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">theta =</span> <span class="kw">seq</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>, <span class="fl">0.005</span>),</a>
<a class="sourceLine" id="cb388-13" data-line-number="13">    <span class="dt">mu =</span> <span class="kw">seq</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>, <span class="fl">0.005</span>))</a>
<a class="sourceLine" id="cb388-14" data-line-number="14"></a>
<a class="sourceLine" id="cb388-15" data-line-number="15">grid_inicial &lt;-<span class="st"> </span>grid_inicial <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-16" data-line-number="16"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">p_inicial =</span> <span class="kw">p_conjunta</span>(mu, theta, A_mu, B_mu, K))</a>
<a class="sourceLine" id="cb388-17" data-line-number="17"></a>
<a class="sourceLine" id="cb388-18" data-line-number="18">plot_conj_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_inicial, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> mu, <span class="dt">z =</span> p_inicial)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-19" data-line-number="19"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-20" data-line-number="20"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta[<span class="dv">1</span>]), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-21" data-line-number="21"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-22" data-line-number="22"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">p</span>(theta,mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>) </a>
<a class="sourceLine" id="cb388-23" data-line-number="23"></a>
<a class="sourceLine" id="cb388-24" data-line-number="24">plot_conj_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_inicial, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> mu, <span class="dt">z =</span> p_inicial)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-25" data-line-number="25"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-26" data-line-number="26"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta[<span class="dv">2</span>]), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-27" data-line-number="27"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-28" data-line-number="28"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">p</span>(theta,mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>) </a>
<a class="sourceLine" id="cb388-29" data-line-number="29"></a>
<a class="sourceLine" id="cb388-30" data-line-number="30">grid_mu &lt;-<span class="st"> </span>grid_inicial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-31" data-line-number="31"><span class="st">    </span><span class="kw">group_by</span>(mu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-32" data-line-number="32"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">p_mu =</span> <span class="kw">sum</span>(p_inicial)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-33" data-line-number="33"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-34" data-line-number="34"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">p_mu =</span> p_mu <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(p_mu))</a>
<a class="sourceLine" id="cb388-35" data-line-number="35"></a>
<a class="sourceLine" id="cb388-36" data-line-number="36">plot_mu &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_mu, <span class="kw">aes</span>(<span class="dt">x =</span> mu, <span class="dt">y =</span> p_mu)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-37" data-line-number="37"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb388-38" data-line-number="38"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">paste</span>(mu))), <span class="dt">x =</span> <span class="kw">expression</span>(mu)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-39" data-line-number="39"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.015</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_flip</span>()</a>
<a class="sourceLine" id="cb388-40" data-line-number="40"></a>
<a class="sourceLine" id="cb388-41" data-line-number="41">p_marg &lt;-<span class="st"> </span>grid_inicial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-42" data-line-number="42"><span class="st">    </span><span class="kw">group_by</span>(theta) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-43" data-line-number="43"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">marg =</span> <span class="kw">sum</span>(p_inicial)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-44" data-line-number="44"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-45" data-line-number="45"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">marg =</span> marg <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(marg))</a>
<a class="sourceLine" id="cb388-46" data-line-number="46"></a>
<a class="sourceLine" id="cb388-47" data-line-number="47">plot_marg_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_marg, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> marg)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-48" data-line-number="48"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb388-49" data-line-number="49"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(theta[<span class="dv">1</span>])), <span class="dt">x =</span> <span class="kw">expression</span>(theta[<span class="dv">1</span>])) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-50" data-line-number="50"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.02</span>)</a>
<a class="sourceLine" id="cb388-51" data-line-number="51"></a>
<a class="sourceLine" id="cb388-52" data-line-number="52">plot_marg_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(p_marg, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> marg)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-53" data-line-number="53"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb388-54" data-line-number="54"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(theta[<span class="dv">2</span>])), <span class="dt">x =</span> <span class="kw">expression</span>(theta[<span class="dv">2</span>])) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-55" data-line-number="55"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.02</span>)</a>
<a class="sourceLine" id="cb388-56" data-line-number="56"></a>
<a class="sourceLine" id="cb388-57" data-line-number="57"><span class="kw">grid.arrange</span>(plot_conj_<span class="dv">1</span>, plot_conj_<span class="dv">2</span>, plot_mu, plot_marg_<span class="dv">1</span>, plot_marg_<span class="dv">2</span>, </a>
<a class="sourceLine" id="cb388-58" data-line-number="58">    <span class="dt">ncol =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb388-59" data-line-number="59">z_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="dv">3</span>; N_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="dv">15</span></a>
<a class="sourceLine" id="cb388-60" data-line-number="60">z_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="dv">4</span>; N_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb388-61" data-line-number="61"></a>
<a class="sourceLine" id="cb388-62" data-line-number="62">mi_like_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">likeBern</span>(z_<span class="dv">1</span>, N_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb388-63" data-line-number="63">mi_like_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">likeBern</span>(z_<span class="dv">2</span>, N_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb388-64" data-line-number="64"></a>
<a class="sourceLine" id="cb388-65" data-line-number="65">grid_like &lt;-<span class="st"> </span>grid_like <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-66" data-line-number="66"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">L_1 =</span> <span class="kw">mi_like_1</span>(x), <span class="dt">L_2 =</span> <span class="kw">mi_like_2</span>(x))</a>
<a class="sourceLine" id="cb388-67" data-line-number="67"></a>
<a class="sourceLine" id="cb388-68" data-line-number="68">plot_like_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_like, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">z =</span> L_<span class="dv">1</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-69" data-line-number="69"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-70" data-line-number="70"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta[<span class="dv">1</span>]), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-71" data-line-number="71"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-72" data-line-number="72"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">L</span>(theta,mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb388-73" data-line-number="73"></a>
<a class="sourceLine" id="cb388-74" data-line-number="74">plot_like_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_like, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">z =</span> L_<span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-75" data-line-number="75"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-76" data-line-number="76"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta[<span class="dv">1</span>]), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-77" data-line-number="77"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-78" data-line-number="78"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">L</span>(theta,mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb388-79" data-line-number="79"></a>
<a class="sourceLine" id="cb388-80" data-line-number="80"><span class="kw">grid.arrange</span>(plot_like_<span class="dv">1</span>, plot_like_<span class="dv">2</span>, <span class="dt">ncol =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb388-81" data-line-number="81">grid_post &lt;-<span class="st"> </span>grid_inicial <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-82" data-line-number="82"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb388-83" data-line-number="83">        <span class="dt">prior =</span> p_inicial <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(p_inicial),</a>
<a class="sourceLine" id="cb388-84" data-line-number="84">        <span class="dt">Like_1 =</span> theta <span class="op">^</span><span class="st"> </span>z_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>theta) <span class="op">^</span><span class="st"> </span>(N_<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>z_<span class="dv">1</span>), <span class="co"># verosimilitud </span></a>
<a class="sourceLine" id="cb388-85" data-line-number="85">        <span class="dt">posterior_1 =</span> (Like_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>prior) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(Like_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>prior),</a>
<a class="sourceLine" id="cb388-86" data-line-number="86">        <span class="dt">Like_2 =</span> theta <span class="op">^</span><span class="st"> </span>z_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>theta) <span class="op">^</span><span class="st"> </span>(N_<span class="dv">2</span> <span class="op">-</span><span class="st"> </span>z_<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb388-87" data-line-number="87">        <span class="dt">posterior_2 =</span> (Like_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>prior) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(Like_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>prior)</a>
<a class="sourceLine" id="cb388-88" data-line-number="88">      )  </a>
<a class="sourceLine" id="cb388-89" data-line-number="89"></a>
<a class="sourceLine" id="cb388-90" data-line-number="90">post_conj_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_post, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> mu, <span class="dt">z =</span> posterior_<span class="dv">1</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-91" data-line-number="91"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-92" data-line-number="92"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta[<span class="dv">1</span>]), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-93" data-line-number="93"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-94" data-line-number="94"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">p</span>(theta[<span class="dv">1</span>],mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>) </a>
<a class="sourceLine" id="cb388-95" data-line-number="95"></a>
<a class="sourceLine" id="cb388-96" data-line-number="96">post_conj_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_post, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> mu, <span class="dt">z =</span> posterior_<span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-97" data-line-number="97"><span class="st">    </span><span class="kw">stat_contour</span>(<span class="kw">aes</span>(<span class="dt">color =</span> ..level..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-98" data-line-number="98"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(theta[<span class="dv">2</span>]), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-99" data-line-number="99"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(mu), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-100" data-line-number="100"><span class="st">    </span><span class="kw">scale_color_gradient</span>(<span class="kw">expression</span>(<span class="kw">p</span>(theta[<span class="dv">2</span>],mu)), <span class="dt">guide =</span> <span class="ot">FALSE</span>) </a>
<a class="sourceLine" id="cb388-101" data-line-number="101"></a>
<a class="sourceLine" id="cb388-102" data-line-number="102">grid_mu &lt;-<span class="st"> </span>grid_post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-103" data-line-number="103"><span class="st">    </span><span class="kw">group_by</span>(mu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-104" data-line-number="104"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">post_mu =</span> <span class="kw">sum</span>(posterior_<span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(posterior_<span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-105" data-line-number="105"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-106" data-line-number="106"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">post_mu =</span> post_mu <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(post_mu))</a>
<a class="sourceLine" id="cb388-107" data-line-number="107"></a>
<a class="sourceLine" id="cb388-108" data-line-number="108">post_mu &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_mu, <span class="kw">aes</span>(<span class="dt">x =</span> mu, <span class="dt">y =</span> post_mu)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-109" data-line-number="109"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb388-110" data-line-number="110"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">paste</span>(mu, l, x))), <span class="dt">x =</span> <span class="kw">expression</span>(mu)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-111" data-line-number="111"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.015</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-112" data-line-number="112"><span class="st">    </span><span class="kw">coord_flip</span>()</a>
<a class="sourceLine" id="cb388-113" data-line-number="113"></a>
<a class="sourceLine" id="cb388-114" data-line-number="114">grid_theta &lt;-<span class="st"> </span>grid_post <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-115" data-line-number="115"><span class="st">    </span><span class="kw">group_by</span>(theta) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-116" data-line-number="116"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">post_theta_1 =</span> <span class="kw">sum</span>(posterior_<span class="dv">1</span>), </a>
<a class="sourceLine" id="cb388-117" data-line-number="117">        <span class="dt">post_theta_2 =</span> <span class="kw">sum</span>(posterior_<span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-118" data-line-number="118"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb388-119" data-line-number="119"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">post_theta_1 =</span> post_theta_<span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(post_theta_<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb388-120" data-line-number="120"></a>
<a class="sourceLine" id="cb388-121" data-line-number="121">post_theta_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_theta, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> post_theta_<span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-122" data-line-number="122"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb388-123" data-line-number="123"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">paste</span>(theta[<span class="dv">1</span>], l, x))), <span class="dt">x =</span> <span class="kw">expression</span>(theta[<span class="dv">1</span>])) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-124" data-line-number="124"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.020</span>)</a>
<a class="sourceLine" id="cb388-125" data-line-number="125"></a>
<a class="sourceLine" id="cb388-126" data-line-number="126">post_theta_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(grid_theta, <span class="kw">aes</span>(<span class="dt">x =</span> theta, <span class="dt">y =</span> post_theta_<span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-127" data-line-number="127"><span class="st">    </span><span class="kw">geom_path</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb388-128" data-line-number="128"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">p</span>(<span class="kw">paste</span>(theta[<span class="dv">2</span>], l, x))), <span class="dt">x =</span> <span class="kw">expression</span>(theta[<span class="dv">2</span>])) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-129" data-line-number="129"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.020</span>)</a>
<a class="sourceLine" id="cb388-130" data-line-number="130"></a>
<a class="sourceLine" id="cb388-131" data-line-number="131"><span class="kw">grid.arrange</span>(post_conj_<span class="dv">1</span>, post_conj_<span class="dv">2</span>, post_mu, post_theta_<span class="dv">1</span>, post_theta_<span class="dv">2</span>, </a>
<a class="sourceLine" id="cb388-132" data-line-number="132">             <span class="dt">ncol =</span> <span class="dv">3</span>)</a></code></pre></div>
</div>
<div id="stan-1" class="section level4 unnumbered">
<h4>Stan</h4>
<p>La sección anterior utilizó un modelo simplificado con el objetivo de poder
visualizar el espacio de parámetros. Ahora incluiremos más parámetros para hacer
el problema más realista. En los ejemplos anteriores fijamos
el grado de dependencia entre <span class="math inline">\(\mu\)</span> y <span class="math inline">\(\theta\)</span> de manera arbitraria, a través
de <span class="math inline">\(K\)</span>, de tal manera que si <span class="math inline">\(K\)</span> era grande, los valores <span class="math inline">\(\theta_j\)</span> individuales
se situaban cerca de <span class="math inline">\(\mu\)</span> y cuando <span class="math inline">\(K\)</span> era pequeña se permitía más variación.</p>
<p>En situaciones reales no conocemos el valor de <span class="math inline">\(K\)</span> por adelantado, por lo que
dejamos que los datos nos informen acerca de valores creíbles para <span class="math inline">\(K\)</span>.
Intuitivamente, cuando la proporción de águilas observadas es similar a lo largo
de las monedas, tenemos evidencia de que <span class="math inline">\(K\)</span> es grande, mientras que si estas
proporciones difieren mucho, tenemos evidencia de que <span class="math inline">\(K\)</span> es pequeña. Debido
a que <span class="math inline">\(K\)</span> pasará de ser una constante a ser un parámetro lo llamaremos <span class="math inline">\(\kappa\)</span>.</p>
<p>La distribución inicial para <span class="math inline">\(\kappa\)</span> será una Gamma.</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb389-1" data-line-number="1">modelo_jer.stan &lt;-</a>
<a class="sourceLine" id="cb389-2" data-line-number="2"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb389-3" data-line-number="3"><span class="st">data {</span></a>
<a class="sourceLine" id="cb389-4" data-line-number="4"><span class="st">    int N;</span></a>
<a class="sourceLine" id="cb389-5" data-line-number="5"><span class="st">    int x[N];</span></a>
<a class="sourceLine" id="cb389-6" data-line-number="6"><span class="st">    int nCoins;</span></a>
<a class="sourceLine" id="cb389-7" data-line-number="7"><span class="st">    int coin[N];</span></a>
<a class="sourceLine" id="cb389-8" data-line-number="8"><span class="st">}</span></a>
<a class="sourceLine" id="cb389-9" data-line-number="9"><span class="st">parameters {</span></a>
<a class="sourceLine" id="cb389-10" data-line-number="10"><span class="st">    real&lt;lower=0,upper=1&gt; theta[nCoins];</span></a>
<a class="sourceLine" id="cb389-11" data-line-number="11"><span class="st">    real&lt;lower=0,upper=1&gt; mu;</span></a>
<a class="sourceLine" id="cb389-12" data-line-number="12"><span class="st">    real&lt;lower=0&gt;  kappa;</span></a>
<a class="sourceLine" id="cb389-13" data-line-number="13"><span class="st">}</span></a>
<a class="sourceLine" id="cb389-14" data-line-number="14"><span class="st">transformed parameters {</span></a>
<a class="sourceLine" id="cb389-15" data-line-number="15"><span class="st">    real&lt;lower=0&gt;  a;</span></a>
<a class="sourceLine" id="cb389-16" data-line-number="16"><span class="st">    real&lt;lower=0&gt;  b;</span></a>
<a class="sourceLine" id="cb389-17" data-line-number="17"><span class="st">    a = mu * kappa;</span></a>
<a class="sourceLine" id="cb389-18" data-line-number="18"><span class="st">    b = (1-mu) * kappa;</span></a>
<a class="sourceLine" id="cb389-19" data-line-number="19"><span class="st">}</span></a>
<a class="sourceLine" id="cb389-20" data-line-number="20"><span class="st">model {</span></a>
<a class="sourceLine" id="cb389-21" data-line-number="21"><span class="st">    theta ~ beta(a,b);</span></a>
<a class="sourceLine" id="cb389-22" data-line-number="22"><span class="st">    x ~ bernoulli(theta[coin]);</span></a>
<a class="sourceLine" id="cb389-23" data-line-number="23"><span class="st">    mu ~ beta(2, 2);</span></a>
<a class="sourceLine" id="cb389-24" data-line-number="24"><span class="st">    kappa ~ gamma(1, 0.1);</span></a>
<a class="sourceLine" id="cb389-25" data-line-number="25"><span class="st">}</span></a>
<a class="sourceLine" id="cb389-26" data-line-number="26"></a>
<a class="sourceLine" id="cb389-27" data-line-number="27"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb389-28" data-line-number="28"><span class="kw">cat</span>(modelo_jer.stan, <span class="dt">file =</span> <span class="st">&quot;src/stan_files/modelo_jer.stan&quot;</span>)</a>
<a class="sourceLine" id="cb389-29" data-line-number="29">stan_jer_cpp &lt;-<span class="st"> </span><span class="kw">stan_model</span>(<span class="st">&quot;src/stan_files/modelo_jer.stan&quot;</span>)</a></code></pre></div>
<p><span class="math inline">\(\kappa \sim Gamma(1, 0.1)\)</span>, tiene media <span class="math inline">\(10\)</span> y desviación estándar <span class="math inline">\(10\)</span>.</p>
<p>Los datos consisten en <span class="math inline">\(5\)</span> monedas, cada una se lanza <span class="math inline">\(5\)</span> veces, resultando <span class="math inline">\(4\)</span>
de ellas en <span class="math inline">\(1\)</span> águila y <span class="math inline">\(4\)</span> soles y otra en <span class="math inline">\(3\)</span> águilas y <span class="math inline">\(2\)</span> soles.</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb390-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb390-2" data-line-number="2">coin &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="kw">rep</span>(<span class="dv">2</span>, <span class="dv">5</span>), <span class="kw">rep</span>(<span class="dv">3</span>, <span class="dv">5</span>), <span class="kw">rep</span>(<span class="dv">4</span>, <span class="dv">5</span>), <span class="kw">rep</span>(<span class="dv">5</span>, <span class="dv">5</span>))</a>
<a class="sourceLine" id="cb390-3" data-line-number="3"></a>
<a class="sourceLine" id="cb390-4" data-line-number="4">stan_jer_fit &lt;-<span class="st"> </span><span class="kw">sampling</span>(stan_jer_cpp, </a>
<a class="sourceLine" id="cb390-5" data-line-number="5">    <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">x =</span> x, <span class="dt">coin =</span> coin, <span class="dt">nCoins =</span> <span class="dv">5</span>,  <span class="dt">N =</span> <span class="dv">25</span>), <span class="dt">chains =</span> <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb390-6" data-line-number="6">    <span class="dt">iter =</span> <span class="dv">1000</span>, <span class="dt">warmup =</span> <span class="dv">500</span>)</a></code></pre></div>
<p>Graficamos la distribución posterior de <span class="math inline">\(\mu\)</span> y <span class="math inline">\(\theta_i\)</span>.</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb391-1" data-line-number="1">posterior_jer &lt;-<span class="st"> </span><span class="kw">extract</span>(stan_jer_fit, <span class="dt">inc_warmup =</span> <span class="ot">TRUE</span>, <span class="dt">permuted =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb391-2" data-line-number="2"></a>
<a class="sourceLine" id="cb391-3" data-line-number="3"><span class="kw">mcmc_areas</span>(posterior_jer, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;mu&quot;</span>, <span class="st">&quot;theta[1]&quot;</span>, <span class="st">&quot;theta[2]&quot;</span>, <span class="st">&quot;theta[3]&quot;</span>, </a>
<a class="sourceLine" id="cb391-4" data-line-number="4">    <span class="st">&quot;theta[4]&quot;</span>, <span class="st">&quot;theta[5]&quot;</span>), <span class="dt">prob =</span> <span class="fl">0.8</span>, <span class="dt">point_est =</span> <span class="st">&quot;median&quot;</span>, <span class="dt">adjust =</span> <span class="fl">1.4</span>) </a>
<a class="sourceLine" id="cb391-5" data-line-number="5"><span class="co">#&gt; Error in mcmc_areas(posterior_jer, pars = c(&quot;mu&quot;, &quot;theta[1]&quot;, &quot;theta[2]&quot;, : could not find function &quot;mcmc_areas&quot;</span></a></code></pre></div>
<p>Y para el resto de los parámetros.</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb392-1" data-line-number="1"><span class="kw">mcmc_areas</span>(posterior_jer, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;kappa&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>), <span class="dt">prob =</span> <span class="fl">0.8</span>, <span class="dt">point_est =</span> <span class="st">&quot;median&quot;</span>, </a>
<a class="sourceLine" id="cb392-2" data-line-number="2">    <span class="dt">adjust =</span> <span class="fl">1.4</span>)</a>
<a class="sourceLine" id="cb392-3" data-line-number="3"><span class="co">#&gt; Error in mcmc_areas(posterior_jer, pars = c(&quot;kappa&quot;, &quot;a&quot;, &quot;b&quot;), prob = 0.8, : could not find function &quot;mcmc_areas&quot;</span></a></code></pre></div>
</div>
</div>
<div id="ejemplo-estimación-de-tasas-de-mortalidad" class="section level3 unnumbered">
<h3>Ejemplo: estimación de tasas de mortalidad</h3>
<p>En esta sección veremos un problema de estimación de tasas de mortalidad,
la referencia de este ejemplo es <span class="citation">Albert (<a href="#ref-albert">2009</a>)</span>. Plantearemos <span class="math inline">\(3\)</span> alternativas de
modelación para resolver el problema: 1) modelo de unidades iguales, 2) modelo
de unidades independientes, y 3) modelo jerárquico.</p>
<p>Los datos consisten en información de todas las cirugías de transplante de
corazón llevadas a cabo en Estados Unidos en un periodo de <span class="math inline">\(24\)</span> meses, entre
octubre de <span class="math inline">\(1987\)</span> y diciembre de <span class="math inline">\(1989\)</span>. Para cada uno de los <span class="math inline">\(131\)</span> hospitales,
se registró:</p>
<ul>
<li><p>el número de cirugías de transplante de corazón,</p></li>
<li><p>y el número de muertes durante los <span class="math inline">\(30\)</span> días posteriores a la cirugía, <span class="math inline">\(y\)</span>.</p></li>
<li><p>Además, se cuenta con una predicción de la probabilidad de muerte de cada
paciente individual. Esta predicción esta basada en un modelo logístico que
incluye información a nivel paciente como condición médica antes de la cirugía,
género, sexo y raza. En cada hospital se suman las probabilidades de muerte de
sus pacientes para calcular el número esperado de muertes, <span class="math inline">\(e\)</span>, conocido como la
exposición del hospital. <span class="math inline">\(e\)</span> refleja el riesgo de muerte debido a la mezcla de
pacientes que componen un hospital particular.</p></li>
</ul>
<p>La tabla de datos que analizaremos considera únicamente los <span class="math inline">\(94\)</span> hospitales que
llevaron a cabo <span class="math inline">\(10\)</span> o más cirugías, y contiene las duplas <span class="math inline">\((y_{j}, e_{j})\)</span> que
corresponden al número observado de muertes y número de expuestos para el
<span class="math inline">\(j\)</span>-ésimo hospital, con <span class="math inline">\(j = 1,...,94\)</span>.</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb393-1" data-line-number="1"><span class="kw">library</span>(LearnBayes)</a>
<a class="sourceLine" id="cb393-2" data-line-number="2"><span class="kw">data</span>(hearttransplants)</a>
<a class="sourceLine" id="cb393-3" data-line-number="3">heart &lt;-<span class="st"> </span>hearttransplants <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb393-4" data-line-number="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">hospital =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>())</a>
<a class="sourceLine" id="cb393-5" data-line-number="5"><span class="kw">head</span>(heart)</a>
<a class="sourceLine" id="cb393-6" data-line-number="6"><span class="co">#&gt;      e y hospital</span></a>
<a class="sourceLine" id="cb393-7" data-line-number="7"><span class="co">#&gt; 1  532 0        1</span></a>
<a class="sourceLine" id="cb393-8" data-line-number="8"><span class="co">#&gt; 2  584 0        2</span></a>
<a class="sourceLine" id="cb393-9" data-line-number="9"><span class="co">#&gt; 3  672 2        3</span></a>
<a class="sourceLine" id="cb393-10" data-line-number="10"><span class="co">#&gt; 4  722 1        4</span></a>
<a class="sourceLine" id="cb393-11" data-line-number="11"><span class="co">#&gt; 5  904 1        5</span></a>
<a class="sourceLine" id="cb393-12" data-line-number="12"><span class="co">#&gt; 6 1236 0        6</span></a></code></pre></div>
<p><strong>El objetivo es obtener buenas estimaciones de las tasas de mortalidad de cada
hospital</strong>. Antes de comenzar a ajustar modelos complejos vale la pena observar
los datos.</p>
<ul>
<li><p>El cociente <span class="math inline">\(\{y_{j}/e_{j}\}\)</span> es el número observado de muertes por
unidad de exposición y se puede ver como una estimación de la tasa de
mortalidad.</p></li>
<li><p>La siguiente figura grafica, en el eje vertical los cocientes
<span class="math inline">\(\{y_{j}/e_{j}\}\)</span> multiplicados por <span class="math inline">\(1000\)</span> (con la intención de que la tasa
indique número de muertes por <span class="math inline">\(1000\)</span> expuestos), y en el eje horizontal el
número de expuestos <span class="math inline">\(\{e_{j}\}\)</span> -en escala logarítmica- para los <span class="math inline">\(94\)</span>
hospitales. Cada punto representa un hospital y esta etiquetado con el número de
muertes observadas <span class="math inline">\(\{y_{j}\}\)</span>.</p></li>
<li><p>En la gráfica podemos notar que las tasas estimadas son
muy variables, especialmente para programas con baja exposición.</p></li>
<li><p>Observemos también, que la mayoría de los programas que no experimentaron
muertes tienen bajo número de expuestos.</p></li>
</ul>
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb394-1" data-line-number="1"><span class="kw">ggplot</span>(heart, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> <span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>y <span class="op">/</span><span class="st"> </span>e, <span class="dt">color =</span> <span class="kw">factor</span>(y), <span class="dt">label =</span> y)) <span class="op">+</span></a>
<a class="sourceLine" id="cb394-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">show.legend =</span> <span class="ot">FALSE</span>)  <span class="op">+</span></a>
<a class="sourceLine" id="cb394-3" data-line-number="3"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Número de expuestos (e)&quot;</span>, <span class="dt">labels =</span> exp, </a>
<a class="sourceLine" id="cb394-4" data-line-number="4">        <span class="dt">breaks =</span> <span class="kw">map_dbl</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">700</span> <span class="op">^</span><span class="st"> </span>.))) </a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-73-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>La variabilidad de las tasas y los hospitales sin muertes sugieren un problema
de tamaño de muestra:</p>
<p>Consideremos un hospital con <span class="math inline">\(700\)</span> expuestos, la muerte
por transplante de corazón no es común, el promedio nacional es de <span class="math inline">\(9\)</span> por cada
<span class="math inline">\(10,000\)</span> expuestos, por lo que con <span class="math inline">\(700\)</span> expuestos es probable que no se
presente ninguna muerte,</p>
<ul>
<li><p>en este caso el hospital pertenece al <span class="math inline">\(10\%\)</span> de los hospitales con menor tasa
de mortalidad.</p></li>
<li><p>Sin embargo, existe la posibilidad de que se observe una muerte, con lo cual
el hospital tendrá una tasa de mortalidad que es lo suficientemente alta para
que quede en el <span class="math inline">\(25\%\)</span> de los hospitales con mayor tasa de mortalidad observada.</p></li>
</ul>
<p>Una vez reconocido el problema de utilizar los datos crudos para estimar las
tasas de mortalidad plantearemos <span class="math inline">\(3\)</span> alternativas de modelación:</p>
<ol style="list-style-type: decimal">
<li><strong>Unidades iguales</strong>. Considera que los estudios son replicas idénticas una
de otra, en este sentido vemos a las observaciones de todos los estudios como
muestras independientes de una misma población y consecuentemente todas las
<span class="math inline">\(\lambda_{j}\)</span> se consideran iguales,</li>
</ol>
<p><span class="math display">\[
  \begin{eqnarray}
        \nonumber
        y_{j} &amp;\sim&amp; f(y_{j}|\lambda),\\
        \nonumber
        \lambda &amp;\sim&amp; g(\lambda).
    \end{eqnarray} 
\]</span></p>
<p>El modelo gráfico correspondiente a este enfoque (omitiendo la distribución de
<span class="math inline">\(\lambda\)</span>) es:</p>
<center>
<img src="img/dag_pool.png" width="400px"/>
</center>
<ol start="2" style="list-style-type: decimal">
<li><strong>Unidades independientes</strong>. El extremo opuesto a unidades iguales considera
que los estudios son tan diferentes que los resultados de cada uno no proveen información acerca de los resultados de ningún otro y por tanto realizamos
estimaciones individuales para cada <span class="math inline">\(\lambda_{j}\)</span>,</li>
</ol>
<p><span class="math display">\[
  \begin{align}
        \nonumber
        y_{j} &amp;\sim f(y_{j}|\lambda_{j}),\\
        \nonumber
        \lambda_j &amp;\stackrel{\mathrm{iid}}{\sim} g(\lambda_j).
    \end{align}
\]</span></p>
<p>Con el siguiente modelo gráfico:</p>
<center>
<img src="img/dag_ind.png" width="400px"/>
</center>
<ol start="3" style="list-style-type: decimal">
<li><strong>Jerárquico</strong>. Es un análisis intermedio que considera los parámetros de interés
<span class="math inline">\(\lambda_{j}\)</span> como provenientes de una distribución común,</li>
</ol>
<p><span class="math display">\[
\begin{eqnarray}
        \nonumber
        y_{j} &amp;\sim&amp; f(y_{j}|\lambda_{j}),\\
        \nonumber
        \lambda_{j} &amp;\sim&amp; g(\lambda_j|\theta),\\
        \theta &amp;\sim&amp; h(\theta).
    \end{eqnarray} 
\]</span></p>
<center>
<img src="img/dag_jer.png" width="400px"/>
</center>
<p>De esta manera, la probabilidad conjunta del modelo refleja una dependencia
entre los parámetros al mismo tiempo que permite variaciones entre los estudios.
Como resultado se estima una <span class="math inline">\(\lambda_{j}\)</span> diferente para cada estudio usando
información de todos.</p>
<div id="modelo-de-unidades-iguales" class="section level4 unnumbered">
<h4>Modelo de unidades iguales</h4>
<p>Supongamos que las tasas de mortalidad son iguales a lo largo de los hospitales.
Estimaremos la tasa de mortalidad con el modelo,</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
y_{j} \sim Poisson(e_{j}\lambda),
\end{eqnarray}
\]</span></p>
<p>donde <span class="math inline">\(y_{j}\)</span> es el número de muertes observadas por transplante corazón en el
hospital <span class="math inline">\(j\)</span>, <span class="math inline">\(e_{j}\)</span> es el número de expuestos, y <span class="math inline">\(\lambda\)</span> es la tasa de
mortalidad, medida en número de muertes por unidad de exposción y común para
todos los hospitales.</p>
<p>Debido a que no contamos con información inicial acerca de la tasa de mortalidad,
asignamos a <span class="math inline">\(\lambda\)</span> una distribución inicial no informativa, de la forma</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
     g(\lambda)\propto\frac{1}{\lambda}.
\end{eqnarray}
\]</span></p>
<p>Sea <span class="math inline">\(y=(y_1,...,y_{94})\)</span>, usamos el Teorema de Bayes para calcular la densidad
posterior de <span class="math inline">\(\lambda\)</span>,</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    g(\lambda|y) &amp;\propto&amp; g(\lambda)f(y|\lambda) \\
    \nonumber
    &amp;=&amp; g(\lambda)\prod_{i=1}^{94}f(y_{i}|\lambda)\\
    \nonumber
    &amp;=&amp; \frac{1}{\lambda}\prod_{i=1}^{94}\bigg(\frac{exp(-e_{i}\lambda)(e_{i}\lambda)^{y_{i}}}{y_{i}!}\bigg)\\
    \nonumber
    &amp;\propto&amp; \lambda^{(\sum_{i=1}^{94}y_{j}-1)}exp\bigg(-\sum_{i=1}^{94}e_{j}\lambda\bigg),
\end{eqnarray}
\]</span></p>
<p>identificamos la densidad posterior como una
<span class="math inline">\(Gamma(\sum_{i=1}^{94}y_{i},\sum_{i=1}^{94}e_{i})\)</span>, donde expresamos la función
de densidad de una distribución <span class="math inline">\(Gamma(\alpha, \beta)\)</span> usando el parámetro de
forma <span class="math inline">\(\alpha\)</span> y el inverso del parámetro de escala <span class="math inline">\(\beta\)</span> de manera que la
función de densidad es,</p>
<p><span class="math display">\[
\begin{align}
    \nonumber
    &amp;f(x|\alpha, \beta) = \beta^{\alpha}\frac{1}{\Gamma(\alpha)}x^{\alpha-1}e^{-\beta x}I_{(0,\infty)}(x)\\
    \nonumber
    &amp;\mbox{para }x \geq 0 \mbox{ y }\alpha \mbox{, }\beta &gt; 0.
\end{align}
\]</span></p>
<p>Para verificar el ajuste del modelo utilizaremos la distribución predictiva
posterior. Denotemos <span class="math inline">\(y_{j}^*\)</span> el número de muertes por transplante en el
hospital <span class="math inline">\(j\)</span> con exposición <span class="math inline">\(e_{j}\)</span> en una muestra futura. Condicional a
<span class="math inline">\(\lambda\)</span>, <span class="math inline">\(y_{j}^*\)</span> se distribuye <span class="math inline">\(Poisson(e_{j}\lambda)\)</span>, no conocemos el
verdadero valor de <span class="math inline">\(\lambda\)</span>, sin embargo nuestro conocimiento actual está
contenido en la densidad posterior <span class="math inline">\(g(\lambda|y)\)</span>. Por tanto, la distribución
predictiva posterior de <span class="math inline">\(y_{j}^*\)</span> esta dada por:</p>
<p><span class="math display">\[
\begin{eqnarray}
\nonumber
    f(y_{j}^*|e_{j},y) = \int f(y_{j}^*|e_{j}\lambda)g(\lambda|y)d\lambda, 
\end{eqnarray}
\]</span></p>
<p>donde <span class="math inline">\(f(y_j^*|e_{j}\lambda)\)</span> es una densidad Poisson con media <span class="math inline">\(\lambda\)</span>. La
densidad predictiva posterior representa la verosimilitud de observaciones
futuras basadas en el modelo ajustado.</p>
<p>En este ejemplo, la densidad
<span class="math inline">\(f(y_{j}^*|e_{j},y)\)</span> representa el número de transplantes que se predecirían
para un hospital con exposición <span class="math inline">\(e_{j}\)</span>. Entonces, si el número observado de
muertes <span class="math inline">\(y_{j}\)</span> no está en las colas de la distribución predictiva, diríamos que
la observación es consistente con el modelo observado.</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb395-1" data-line-number="1"><span class="co"># La densidad posterior es Gamma con los siguientes parámetros</span></a>
<a class="sourceLine" id="cb395-2" data-line-number="2"><span class="kw">c</span>(<span class="kw">sum</span>(heart<span class="op">$</span>y), <span class="kw">sum</span>(heart<span class="op">$</span>e))</a>
<a class="sourceLine" id="cb395-3" data-line-number="3"><span class="co">#&gt; [1]    277 294681</span></a>
<a class="sourceLine" id="cb395-4" data-line-number="4"><span class="co"># Simulamos 1000 muestras de la densidad posterior de lambda</span></a>
<a class="sourceLine" id="cb395-5" data-line-number="5">lambdas &lt;-<span class="st"> </span><span class="kw">rgamma</span>(<span class="dv">1000</span>, <span class="dt">shape =</span> <span class="kw">sum</span>(heart<span class="op">$</span>y), <span class="dt">rate =</span> <span class="kw">sum</span>(heart<span class="op">$</span>e))</a>
<a class="sourceLine" id="cb395-6" data-line-number="6"><span class="co"># ahora para cada hospital simulamos muestras de una distribución Poisson</span></a>
<a class="sourceLine" id="cb395-7" data-line-number="7"><span class="co"># con media e_i*lambda</span></a>
<a class="sourceLine" id="cb395-8" data-line-number="8">heart_sims &lt;-<span class="st"> </span>heart <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb395-9" data-line-number="9"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sims =</span> <span class="kw">map</span>(e, <span class="op">~</span><span class="kw">rpois</span>(<span class="dv">1000</span>, . <span class="op">*</span><span class="st"> </span>lambdas))) </a>
<a class="sourceLine" id="cb395-10" data-line-number="10"><span class="co"># tomamos una muestra de 10 hospitales</span></a>
<a class="sourceLine" id="cb395-11" data-line-number="11"><span class="kw">set.seed</span>(<span class="dv">242</span>)</a>
<a class="sourceLine" id="cb395-12" data-line-number="12">heart_sims_sample &lt;-<span class="st"> </span><span class="kw">sample_n</span>(heart_sims, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb395-13" data-line-number="13"></a>
<a class="sourceLine" id="cb395-14" data-line-number="14"><span class="kw">ggplot</span>(<span class="kw">unnest</span>(heart_sims_sample, <span class="dt">cols =</span> sims), <span class="kw">aes</span>(<span class="dt">x =</span> sims)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb395-15" data-line-number="15"><span class="st">    </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">y =</span> ..density..), <span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;darkgray&quot;</span>, </a>
<a class="sourceLine" id="cb395-16" data-line-number="16">        <span class="dt">fill =</span> <span class="st">&quot;darkgray&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb395-17" data-line-number="17"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>hospital, <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb395-18" data-line-number="18"><span class="st">    </span><span class="kw">geom_segment</span>(<span class="dt">data =</span> heart_sims_sample, <span class="kw">aes</span>(<span class="dt">x =</span> y, <span class="dt">xend =</span> y, <span class="dt">y =</span> <span class="dv">0</span>, </a>
<a class="sourceLine" id="cb395-19" data-line-number="19">        <span class="dt">yend =</span> <span class="fl">0.5</span>), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb395-20" data-line-number="20"><span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">data =</span> heart_sims_sample, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">10</span>, <span class="dt">y =</span> <span class="fl">0.4</span>, </a>
<a class="sourceLine" id="cb395-21" data-line-number="21">    <span class="dt">label =</span> <span class="kw">paste</span>(<span class="st">&quot;e =&quot;</span>, e)), <span class="dt">size =</span> <span class="fl">2.7</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>)</a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-74-1.png" width="550px" style="display: block; margin: auto;" /></p>
<p>La figura muestra los histogramas, obtenidos con simulación, de la distribución
predictiva posterior de <span class="math inline">\(10\)</span> hospitales (se tomó una muestra de los <span class="math inline">\(94\)</span>). Para cada
hospital, se escribió el número de expuestos, <span class="math inline">\(e\)</span>, y se grafica una línea
vertical en el número de muertes observado. Notemos que en muchos de los
histogramas el número de muertes observado se encuentra en las colas de las
distribuciones, lo que sugiere que nuestras observaciones son inconsistentes con
el modelo ajustado.</p>
<p>Ahora examinaremos la consistencia de las muertes observadas, <span class="math inline">\(y_{j}\)</span>, para
todos los hospitales. Para cada distribución predictiva posterior calculamos la
probabilidad de que una observación futura <span class="math inline">\(y_{j}^*\)</span> sea al menos tan extrema
como <span class="math inline">\(y_{j}\)</span>, estas probabilidades son comúnmente llamadas valores <span class="math inline">\(p\)</span>
predictivos:</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    P(extremos) = min\{P(y_{j}^* \leq y_{j}),P(y_{j}^*\geq y_{j})\}
\end{eqnarray}
\]</span></p>
<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb396-1" data-line-number="1"><span class="co"># Para calcular las p predictiva podemos usar las simulaciones</span></a>
<a class="sourceLine" id="cb396-2" data-line-number="2">p_pred &lt;-<span class="st"> </span>heart_sims <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb396-3" data-line-number="3"><span class="st">    </span><span class="kw">unnest</span>(<span class="dt">cols =</span> sims) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb396-4" data-line-number="4"><span class="st">    </span><span class="kw">group_by</span>(hospital) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb396-5" data-line-number="5"><span class="st">    </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb396-6" data-line-number="6">        <span class="dt">p =</span> <span class="kw">min</span>(<span class="kw">sum</span>(sims <span class="op">&lt;=</span><span class="st"> </span>y) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>, <span class="kw">sum</span>(sims <span class="op">&gt;=</span><span class="st"> </span>y) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>), </a>
<a class="sourceLine" id="cb396-7" data-line-number="7">        <span class="dt">e =</span> <span class="kw">first</span>(e)</a>
<a class="sourceLine" id="cb396-8" data-line-number="8">        )</a>
<a class="sourceLine" id="cb396-9" data-line-number="9"></a>
<a class="sourceLine" id="cb396-10" data-line-number="10"><span class="kw">ggplot</span>(p_pred, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> p)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb396-11" data-line-number="11"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb396-12" data-line-number="12"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Número de expuestos (e)&quot;</span>, <span class="dt">labels =</span> exp, </a>
<a class="sourceLine" id="cb396-13" data-line-number="13">        <span class="dt">breaks =</span> <span class="kw">map_dbl</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">700</span> <span class="op">^</span><span class="st"> </span>.))) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb396-14" data-line-number="14"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;P(extremos)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb396-15" data-line-number="15"><span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">.15</span>, <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb396-16" data-line-number="16"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">.7</span>) </a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-75-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>En la figura anterior graficamos las probabilidades de extremos (calculadas con
simulación) en el eje vertical, contra el número de exposición en escala
logarítmica de cada hospital en el eje horizontal. Notemos que muchas de estas
probabilidades son pequeñas, el <span class="math inline">\(28\%\)</span> son menores a <span class="math inline">\(0.15\)</span>, lo que indica que
para el <span class="math inline">\(28\%\)</span> de los hospitales el número de muertes observado <span class="math inline">\(y_{j}\)</span> está en
la cola de la distribución y por consiguiente el modelo es inadecuado.</p>
</div>
<div id="modelo-de-unidades-independientes" class="section level4 unnumbered">
<h4>Modelo de unidades independientes</h4>
<p>Consideremos ahora que los hospitales son independientes, estimaremos la tasa de
mortalidad para cada hospital con el modelo</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    y_{j}\sim Poisson(e_{j}\lambda_{j}),
\end{eqnarray}
\]</span></p>
<p>donde <span class="math inline">\(y_{j}\)</span> es el número de muertes observadas por transplante corazón en el
hospital <span class="math inline">\(j\)</span>, <span class="math inline">\(e_{j}\)</span> es el número de expuestos, y <span class="math inline">\(\lambda_{j}\)</span> es la tasa de
mortalidad, medida en número de muertes por unidad de exposición, con
<span class="math inline">\(j=1,...,94\)</span>. Utilizamos el subíndice <span class="math inline">\(j\)</span> para enfatizar que son parámetros
diferentes, cada uno estimado con sus propios datos.</p>
<p>Por facilidad asignamos a <span class="math inline">\(\lambda_{j}\)</span> una distribución inicial
<span class="math inline">\(Gamma(\alpha_{0}, \beta_{0})\)</span> que es conjugada de la distribución Poisson,</p>
<p><span class="math display">\[
\begin{eqnarray}
\nonumber
    g(\lambda_{j}|\alpha_{0},\beta_{0}) = \frac{\beta_{0}^{\alpha_{0}} \lambda_{j}^{\alpha_{0}-1}exp(-\lambda_{j} \beta_{0})}{\Gamma(\alpha_{0})}, \lambda_{j}&gt;0.
\end{eqnarray}
\]</span></p>
<p>Calculamos la densidad posterior de <span class="math inline">\(\lambda_{j}\)</span> usando el Teorema de Bayes,</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    g(\lambda_{j}|y_{j},\alpha_{0},\beta_{0}) &amp;\propto&amp; g(\lambda_{j}|\alpha_{0},\beta_{0})f(y_{j}|\lambda_{j})\\
    \nonumber
    &amp;=&amp; \frac{\beta_{0}^{\alpha_{0}} \lambda_{j}^{\alpha_{0}-1}exp(-\lambda_{j} \beta_{0})}{\Gamma(\alpha_{0})}\frac{exp(-e_{j}\lambda_{j})(e_{j}\lambda_{j})^{y_{j}}}{y_{j}!}\\
    \nonumber
    &amp;\propto&amp; \lambda_{j}^{\alpha_{0}+y_{j}-1}exp(-\lambda_{j}(\beta_{0}+e_{j})),
\end{eqnarray}
\]</span></p>
<p>y obtenemos que <span class="math inline">\(\lambda_{j}|y_{j} \sim Gamma(\alpha_{0}+y_{j}, \beta_{0}+e_{j})\)</span>, con media</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    E(\lambda_{j}|y_{j},\alpha_{0},\beta_{0}) &amp;=&amp; \frac{\alpha_{0}+y_{j}}{\beta_{0}+e_{j}}\\
    \label{eqn:pond.indep}
    &amp;=&amp; (1-A_{j})\frac{y_{j}}{e_{j}}+A_{j}\frac{\alpha_{0}}{\beta_{0}}
\end{eqnarray}
\]</span></p>
<p>donde</p>
<p><span class="math display">\[
\begin{eqnarray}
    A_{j}=\frac{\beta_{0}}{\beta_{0}+e_{j}},
\end{eqnarray}
\]</span>
y varianza</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    Var(\lambda_{j} |y_{j},\alpha_{0},\beta_{0}) = \frac{\alpha_{0}+y_{j}}{(\beta_{0}+e_{j})^2}.
\end{eqnarray}
\]</span></p>
<p>Notemos que podemos escribir la media posterior como un promedio ponderado de la
tasa observada <span class="math inline">\(y_{j}/e_{j}\)</span> y la media inicial <span class="math inline">\(\alpha_{0} / \beta_{0}\)</span>. El
factor <span class="math inline">\(A_{j}\)</span> es el encogimiento hacia la media inicial y depende del número de
exposición de cada hospital y del parámetro de escala <span class="math inline">\(\beta_{0}\)</span>.</p>
<div id="efecto-de-beta_0-y-e_j-en-la-distribución-posterior" class="section level5 unnumbered">
<h5>Efecto de <span class="math inline">\({\beta_{0}}\)</span> y <span class="math inline">\({e_{j}}\)</span> en la distribución posterior</h5>
<p>Consideremos la media y varianza posteriores de <span class="math inline">\(\lambda_{j}\)</span> para un hospital
particular. Tomando <span class="math inline">\(\alpha_{0}\)</span> fija, valores mayores de <span class="math inline">\(\beta_{0}\)</span>
corresponden a una menor varianza en la distribución inicial pues
<span class="math inline">\(Var(\lambda_{j} | \alpha_{0},\beta_{0}) = \alpha_{0}/\beta_{0}^2\)</span>. La varianza
de la distribución inicial se refleja en la media de la distribución posterior
de <span class="math inline">\(\lambda_{j}\)</span> a través de <span class="math inline">\(\beta_{0}\)</span>, menor varianza (mayor <span class="math inline">\(\beta_{0}\)</span>)
corresponde a mayor encogimineto hacia la media inicial. Este efecto de
<span class="math inline">\(\beta_{0}\)</span> concuerda con la incertidumbre de nuestro conocimiento, pues menor
varianza en la distribución inicial indica menor incertidumbre y la aportación
de la media inicial a la media posterior es más importante. La elección de
<span class="math inline">\(\beta_{0}\)</span> también afecta la varianza, pues un menor valor de <span class="math inline">\(\beta_{0}\)</span>
implica una mayor varianza tanto en la distribución inicial como en la final.</p>
<p>Por su parte, tomando <span class="math inline">\(\alpha_{0}\)</span> y <span class="math inline">\(\beta_{0}\)</span> fijas, el efecto del número de
expuestos <span class="math inline">\(e_{j}\)</span> sobre la media posterior de <span class="math inline">\(\lambda_{j}\)</span> actúa de manera
contraria a <span class="math inline">\(\beta_{0}\)</span>. Un mayor número de expuestos tiene como consecuencia un
menor encogimiento hacia la media inicial, dando mayor importancia a la tasa
observada <span class="math inline">\(y_{j}/e_{j}\)</span>. Esto refleja que más expuestos implican más información
proveniente de la muestra, restando importancia a nuestro conocimiento inicial.
En cuanto a la varianza posterior, es inversamente proporcional al número de
expuestos indicando nuevamente que más expuestos implica más conocimiento y por
tanto menor incertidumbre.</p>
<p>En la siguiente fugura mostraremos el encogimiento hacia la media inicial bajo
distintos escenarios de <span class="math inline">\(\beta_{0}\)</span>, cada punto representa un hospital y el
color indica a que valor de <span class="math inline">\(\beta_{0}\)</span> corresponde. En esta gráfica podemos
apreciar el mayor encogimiento para valores mayores de <span class="math inline">\(\beta_{0}\)</span> y el
decaimiento en el encogimiento conforme aumenta el número de expuestos.</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb397-1" data-line-number="1">heart_indep &lt;-<span class="st"> </span>heart <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb397-2" data-line-number="2"><span class="st">    </span><span class="kw">crossing</span>(<span class="dt">beta_0 =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">100</span>, <span class="dv">10</span>, <span class="fl">0.01</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb397-3" data-line-number="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">encogimiento =</span> beta_<span class="dv">0</span> <span class="op">/</span><span class="st"> </span>(beta_<span class="dv">0</span> <span class="op">+</span><span class="st"> </span>e))</a>
<a class="sourceLine" id="cb397-4" data-line-number="4"></a>
<a class="sourceLine" id="cb397-5" data-line-number="5"><span class="kw">glimpse</span>(heart_indep)</a>
<a class="sourceLine" id="cb397-6" data-line-number="6"><span class="co">#&gt; Observations: 376</span></a>
<a class="sourceLine" id="cb397-7" data-line-number="7"><span class="co">#&gt; Variables: 5</span></a>
<a class="sourceLine" id="cb397-8" data-line-number="8"><span class="co">#&gt; $ e            &lt;int&gt; 532, 532, 532, 532, 584, 584, 584, 584, 672, 672, 672, 6…</span></a>
<a class="sourceLine" id="cb397-9" data-line-number="9"><span class="co">#&gt; $ y            &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 1, 1, 1, 1, 0, 0, 0,…</span></a>
<a class="sourceLine" id="cb397-10" data-line-number="10"><span class="co">#&gt; $ hospital     &lt;int&gt; 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 11, 11, …</span></a>
<a class="sourceLine" id="cb397-11" data-line-number="11"><span class="co">#&gt; $ beta_0       &lt;dbl&gt; 1e-02, 1e+01, 1e+02, 1e+03, 1e-02, 1e+01, 1e+02, 1e+03, …</span></a>
<a class="sourceLine" id="cb397-12" data-line-number="12"><span class="co">#&gt; $ encogimiento &lt;dbl&gt; 1.879664e-05, 1.845018e-02, 1.582278e-01, 6.527415e-01, …</span></a>
<a class="sourceLine" id="cb397-13" data-line-number="13"></a>
<a class="sourceLine" id="cb397-14" data-line-number="14"><span class="kw">ggplot</span>(heart_indep, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> encogimiento, </a>
<a class="sourceLine" id="cb397-15" data-line-number="15">    <span class="dt">color =</span> <span class="kw">factor</span>(beta_<span class="dv">0</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb397-16" data-line-number="16"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.9</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb397-17" data-line-number="17"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Número de expuestos (e)&quot;</span>, <span class="dt">labels =</span> exp, </a>
<a class="sourceLine" id="cb397-18" data-line-number="18">        <span class="dt">breaks =</span> <span class="kw">map_dbl</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">700</span> <span class="op">^</span><span class="st"> </span>.))) <span class="op">+</span></a>
<a class="sourceLine" id="cb397-19" data-line-number="19"><span class="st">    </span><span class="kw">scale_color_hue</span>(<span class="kw">expression</span>(beta[<span class="dv">0</span>])) <span class="op">+</span></a>
<a class="sourceLine" id="cb397-20" data-line-number="20"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;encogimiento (A)&quot;</span>)</a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-76-1.png" width="350px" style="display: block; margin: auto;" /></p>
</div>
<div id="distribución-inicial" class="section level5 unnumbered">
<h5>Distribución inicial</h5>
<p>Establecimos que por facilidad se utilizará una inicial
<span class="math inline">\(Gamma(\alpha_{0},\beta_{0})\)</span>, sin embargo hace falta asignar valores a los
parámetros iniciales. Analizaremos <span class="math inline">\(3\)</span> distintas combinaciones de parámetros
iniciales y su efecto en las estimaciones posteriores.</p>
<p>Para cada combinación de parámetros la siguiente tabla muestra los deciles de
<span class="math inline">\(2000\)</span> simulaciones de una distribución <span class="math inline">\(Gamma(\alpha_0,\beta_{0})\)</span> y los deciles
de las muertes observadas por cada <span class="math inline">\(1000\)</span> expuestos considerando todos los
hospitales; multiplicamos las simulaciones por <span class="math inline">\(1000\)</span> para que indiquen tasas de
mortalidad medidas en número de muertes por <span class="math inline">\(1000\)</span> expuestos. El propósito de la
tabla es describir la forma de la distribución <span class="math inline">\(Gamma\)</span> al cambiar los
parámetros, por ejemplo, una <span class="math inline">\(Gamma(0.01,0.01)\)</span> es muy plana y podríamos
describirla como poco informativa, mientras que una <span class="math inline">\(Gamma(1,1000)\)</span> tiene una
forma más cercana a las tasas de mortalidad observadas.</p>
<table>
<thead>
<tr class="header">
<th>decil</th>
<th><span class="math inline">\((0.01,0.01)\)</span></th>
<th><span class="math inline">\((0.5,0.01)\)</span></th>
<th><span class="math inline">\((1,1000)\)</span></th>
<th>Observados</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>min</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>10</td>
<td>0</td>
<td>890.3</td>
<td>0.1</td>
<td>0</td>
</tr>
<tr class="odd">
<td>20</td>
<td>0</td>
<td>3134.7</td>
<td>0.2</td>
<td>0.3</td>
</tr>
<tr class="even">
<td>30</td>
<td>0</td>
<td>7769.0</td>
<td>0.3</td>
<td>0.5</td>
</tr>
<tr class="odd">
<td>40</td>
<td>0</td>
<td>15036.0</td>
<td>0.5</td>
<td>0.7</td>
</tr>
<tr class="even">
<td>50</td>
<td>0</td>
<td>24293.9</td>
<td>0.7</td>
<td>0.8</td>
</tr>
<tr class="odd">
<td>60</td>
<td>0</td>
<td>37306.0</td>
<td>0.9</td>
<td>1.1</td>
</tr>
<tr class="even">
<td>70</td>
<td>0</td>
<td>57640.2</td>
<td>1.2</td>
<td>1.4</td>
</tr>
<tr class="odd">
<td>80</td>
<td>0</td>
<td>84255.5</td>
<td>1.6</td>
<td>1.7</td>
</tr>
<tr class="even">
<td>90</td>
<td>4.2</td>
<td>140721.9</td>
<td>2.3</td>
<td>2.0</td>
</tr>
<tr class="odd">
<td>max</td>
<td>287307.6</td>
<td>592073.2</td>
<td>7.0</td>
<td>3.9</td>
</tr>
</tbody>
</table>
<p>Ahora realizamos una gráfica para cada pareja de parámetros<br />
<span class="math inline">\((\alpha_0,\beta_{0})\)</span> donde mostramos en negro las tasas observadas, y en color
las estimaciones posteriores de las tasas de mortalidad con intervalos del <span class="math inline">\(95\%\)</span>
de probabilidad, ambas medidas en número de muertes por cada <span class="math inline">\(1000\)</span> expuestos.
Cada punto representa un hospital y el color corresponde al número de muertes
observadas, <span class="math inline">\(\{y_{j}\}\)</span>. Regresaremos a esta gráfica más adelante pero por lo
pronto observemos que tanto las estimaciones como los intervalos de probabilidad
son muy diferentes al cambiar los parámetros de la distribución inicial.</p>
<div class="sourceCode" id="cb398"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb398-1" data-line-number="1"><span class="co"># Procedemos como antes, para cada combinación de alfa y beta simulamos 1000 </span></a>
<a class="sourceLine" id="cb398-2" data-line-number="2"><span class="co"># lambdas de la posterior</span></a>
<a class="sourceLine" id="cb398-3" data-line-number="3">lambdas &lt;-<span class="st"> </span><span class="kw">rgamma</span>(<span class="dv">1000</span>, <span class="dt">shape =</span> <span class="kw">sum</span>(heart<span class="op">$</span>y), <span class="dt">rate =</span> <span class="kw">sum</span>(heart<span class="op">$</span>e))</a>
<a class="sourceLine" id="cb398-4" data-line-number="4"><span class="co"># ahora para cada hospital simulamos muestras de una distribución Poisson</span></a>
<a class="sourceLine" id="cb398-5" data-line-number="5"><span class="co"># con media e_i*lambda</span></a>
<a class="sourceLine" id="cb398-6" data-line-number="6">priors &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">alpha =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="dt">beta =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb398-7" data-line-number="7"></a>
<a class="sourceLine" id="cb398-8" data-line-number="8">heart_indep_sims &lt;-<span class="st"> </span>heart <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb398-9" data-line-number="9"><span class="st">    </span><span class="kw">crossing</span>(priors) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb398-10" data-line-number="10"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb398-11" data-line-number="11">        <span class="dt">sims =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(e, y, alpha, beta), <span class="op">~</span><span class="kw">rgamma</span>(<span class="dv">1000</span>, <span class="dt">shape =</span> ..<span class="dv">3</span> <span class="op">+</span><span class="st"> </span>..<span class="dv">2</span>, </a>
<a class="sourceLine" id="cb398-12" data-line-number="12">            <span class="dt">rate =</span> ..<span class="dv">4</span> <span class="op">+</span><span class="st"> </span>..<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb398-13" data-line-number="13">        ) </a>
<a class="sourceLine" id="cb398-14" data-line-number="14"><span class="co"># Creamos intervalos con las simulaciones</span></a>
<a class="sourceLine" id="cb398-15" data-line-number="15">heart_indep_post &lt;-<span class="st"> </span>heart_indep_sims <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb398-16" data-line-number="16"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb398-17" data-line-number="17">        <span class="dt">media =</span> <span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>(alpha <span class="op">+</span><span class="st"> </span>y) <span class="op">/</span><span class="st"> </span>(beta <span class="op">+</span><span class="st"> </span>e), </a>
<a class="sourceLine" id="cb398-18" data-line-number="18">        <span class="dt">int_l =</span> <span class="kw">map_dbl</span>(sims, <span class="op">~</span><span class="kw">quantile</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>., <span class="fl">0.025</span>)), </a>
<a class="sourceLine" id="cb398-19" data-line-number="19">        <span class="dt">int_u =</span> <span class="kw">map_dbl</span>(sims, <span class="op">~</span><span class="kw">quantile</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>., <span class="fl">0.975</span>)), </a>
<a class="sourceLine" id="cb398-20" data-line-number="20">        <span class="dt">params =</span> <span class="kw">paste0</span>(<span class="st">&quot;alpha = &quot;</span>, alpha, <span class="st">&quot;, beta = &quot;</span>, beta)</a>
<a class="sourceLine" id="cb398-21" data-line-number="21">        )</a>
<a class="sourceLine" id="cb398-22" data-line-number="22"></a>
<a class="sourceLine" id="cb398-23" data-line-number="23"><span class="kw">ggplot</span>(heart_indep_post, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> media, <span class="dt">color =</span> <span class="kw">factor</span>(y))) <span class="op">+</span></a>
<a class="sourceLine" id="cb398-24" data-line-number="24"><span class="st">    </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> int_l, <span class="dt">ymax =</span> int_u), <span class="dt">size =</span> <span class="fl">0.25</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb398-25" data-line-number="25"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data =</span> heart, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> <span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>y <span class="op">/</span><span class="st"> </span>e), <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, </a>
<a class="sourceLine" id="cb398-26" data-line-number="26">        <span class="dt">alpha =</span> <span class="fl">0.6</span>, <span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb398-27" data-line-number="27"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>params, <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb398-28" data-line-number="28"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Número de expuestos (e)&quot;</span>, <span class="dt">labels =</span> exp, </a>
<a class="sourceLine" id="cb398-29" data-line-number="29">        <span class="dt">breaks =</span> <span class="kw">map_dbl</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">700</span> <span class="op">^</span><span class="st"> </span>.))) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb398-30" data-line-number="30"><span class="st">    </span><span class="kw">scale_colour_hue</span>(<span class="st">&quot;muertes obs. (y)&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb398-31" data-line-number="31"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Muertes por 1000 expuestos&quot;</span>)</a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-77-1.png" width="480" style="display: block; margin: auto;" /></p>
<p>Ahora justificaremos la elección de las parejas de parámetros iniciales. La
única información con la que contamos para definir una distribución inicial es
que la tasa de mortalidad por transplante de corazón debe ser positiva y no muy
grande. Debido a que no tenemos más información nuestro primer modelo utiliza
una inicial vaga.</p>
</div>
<div id="no-informativas" class="section level5 unnumbered">
<h5>No informativas</h5>
<ul>
<li><p>Asignamos a <span class="math inline">\(\lambda_{j}\)</span> una distribución inicial <strong><span class="math inline">\(Gamma(0.01, 0.01)\)</span></strong>. La
tabla de deciles indica que es una distribución muy plana y si observamos la
gráfica de encogimiento notamos que para una inicial con este valor en el
parámetro de escala <span class="math inline">\(\beta_{0}\)</span>, el encogimiento de la media posterior hacia la
media inicial es muy cercano a cero, dando poca importancia a la media inicial
<span class="math inline">\(\alpha_{0}/\beta_{0}=1\)</span>. Como consecuencia, las estimaciones posteriores de
<span class="math inline">\(\lambda_{j}\)</span> son casi iguales a las tasas observadas <span class="math inline">\(\{y_{j}/e_{j}\}\)</span>, y se
presentan los problemas de tamaño de muestra notados al usar las tasas
observadas como estimaciones de las tasas de mortalidad. Además, los intervalos
de confianza para los hospitales que no experimentaron muertes son poco creíbles
pues son mucho más chicos que el resto.</p></li>
<li><p>Consideramos una inicial <strong><span class="math inline">\(Gamma(0.5,0.01)\)</span></strong>. En
este caso, la elección de los parámetros se basó en la distribución inicial no
informativa de Jeffreys, consiste en una <span class="math inline">\(Gamma(0.5,0)\)</span>. Es una distribución
impropia por lo que cambiamos el parámetro de escala por <span class="math inline">\(0.01\)</span> para obtener
una inicial propia con varianza grande. Los resultados no son muy razonables,
pues la media inicial es <span class="math inline">\(50\)</span>, mucho mayor a las tasas observada para todos los
hospitales, provocando que las estimaciones del modelo sean mayores a las tasas
observadas en todos los hospitales. Este efecto es contrario al que buscábamos
al usar una inicial vaga pues la distribución inicial tiene un impacto muy
fuerte en las estimaciones posteriores.</p></li>
</ul>
</div>
<div id="informativa" class="section level5 unnumbered">
<h5>Informativa</h5>
<ul>
<li>Consideramos una distribución inicial <strong><span class="math inline">\(Gamma(1,1000)\)</span></strong>, ésta inicial
es informativa. Para obtener sus parámetros igualamos los media y varianza
teórica de la distribución <span class="math inline">\(Gamma\)</span> con la media y varianza observadas en el
conjunto de tasas de mortalidad tomando en cuenta todos los hospitales.
Las estimaciones de las tasas de mortalidad que obtenemos parecen razonables,
sin embargo, especificar la distribución inicial con la muestra tiene problemas
lógicos y prácticos:
<ul>
<li>Los datos se están usando <span class="math inline">\(2\)</span> veces, primero la
información de todos los hospitales se usa para especificar la distribución
inicial, y después la información de cada hospital se usa para estimar su tasa
de mortalidad <span class="math inline">\(\lambda_{j}\)</span>, lo que ocasiona que sobreestimemos nuestra
precisión.</li>
<li>De acuerdo a la lógica bayesiana no tiene sentido estimar
<span class="math inline">\(\alpha_{0}\)</span> y <span class="math inline">\(\beta_{0}\)</span>, pues son parte de la distribución inicial y no deben
depender de los datos.</li>
</ul></li>
</ul>
<p>A pesar de los problemas señalados parece ser conveniente intentar mejorar las
estimaciones individuales de <span class="math inline">\(\lambda_{j}\)</span> usando la información de todos los
hospitales. La manera correcta de hacerlo es establecer un modelo de
probabilidad para todo el conjunto de parámetros<br />
<span class="math inline">\(\{\alpha,\beta,\lambda_{1},...,\lambda_{94}\}\)</span> y después realizar un análisis
de la distribución conjunta.
Se llevará a cabo un análisis completo en la siguiente sección en donde se usará
un modelo jerárquico.</p>
<p>Podemos concluir que el modelo de unidades independientes no es robusto para
nuestros datos pues las estimaciones posteriores de las tasas de mortalidad son
muy sensibles a la elección de los parámetros de la distribución inicial.</p>
</div>
</div>
<div id="modelo-jerárquico" class="section level4 unnumbered">
<h4>Modelo jerárquico</h4>
<p>En este ejemplo se destaca el modelo jerárquico como una estrategia intermedia
entre el modelo de unidades iguales y el modelo de unidades independientes. Nos
permite reflejar un escenario en donde la información de cada estudio aporta
información acerca del parámetro de interés <span class="math inline">\(\lambda_j\)</span> de los demás estudios
sin considerarlos idénticos, de manera que se estima un parámetro <span class="math inline">\(\lambda_j\)</span>
diferente para cada hospital.</p>
<p>Enumeramos algunas de las ventajas potenciales de usar un modelo jerárquico.</p>
<ol style="list-style-type: decimal">
<li><p>Modelo unificado. El problema de elegir entre un modelo de unidades iguales o
uno de unidades independientes se resuelve al modelar explícitamente la
variabilidad entre las unidades.</p></li>
<li><p>Unir fuerzas. Debido al supuesto de intercambiabilidad, al estimar el
parámetro de cada unidad se usa información de las demás unidades, conllevando a
un encogimiento de la estimación individual hacia la media poblacional, y
resulta en una mejor precisión de las estimaciones. La magnitud del encogimiento
depende de la varianza entre las unidades, y su efecto resulta particularmente
benéfico cuando hay pocas observaciones dentro de una unidad, en cuyo caso hay
una gran reducción de la incertidumbre ya que las estimaciones posteriores
incorporan la información de otras unidades con menor variabilidad.</p></li>
<li><p>Incertidumbre en los parámetros. Asignar una distribución a los
hiperparámetros, <span class="math inline">\(\theta\)</span>, nos permite incorporar nuestra incertidumbre sobre la
distribución inicial de <span class="math inline">\(\lambda\)</span>.</p></li>
<li><p>Cómputo. La estructura jerárquica facilita los cálculos posteriores, debido a
que la distribución posterior se factoriza en distribuciones condicionales más
sencillas que facilitan la implementación de un muestreador de Gibbs.</p></li>
</ol>
<p>Retomando el problema de estimación de tasas de mortalidad por transplante de
corazón, modelaremos las <span class="math inline">\(\lambda_{j}\)</span> con un modelo jerárquico, suponemos
intercambiabilidad para reflejar que no contamos con información que nos permita
distinguir entre los hospitales.</p>
<p>Primero definimos la distribución de los datos,</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
y_{j} \sim Poisson(e_{j}\lambda_{j}),
\end{eqnarray}
\]</span></p>
<p>donde <span class="math inline">\(y_{j}\)</span> es el número de muertes observadas, <span class="math inline">\(e_{j}\)</span> es el número de
expuestos y <span class="math inline">\(\lambda_{j}\)</span> es la tasa de mortalidad para el hospital <span class="math inline">\(j\)</span>, con
<span class="math inline">\(j=1,...,94\)</span>.</p>
<p>Después asignamos una distribución al vector de parámetros
<span class="math inline">\(\lambda=(\lambda_{1},...,\lambda_{94})\)</span>, para ello suponemos que las tasas de
mortalidad <span class="math inline">\(\{\lambda_{1},...,\lambda_{94}\}\)</span> son una muestra aleatoria de una
distribución <span class="math inline">\(Gamma(\alpha,\alpha/\mu)\)</span> con la forma</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    g(\lambda_j|\alpha,\mu)=\frac{(\alpha/\mu)^\alpha\lambda_j^{\alpha-1}exp(-\alpha\lambda_j/\mu)}{\Gamma(\alpha)}, \lambda_j&gt;0.
\end{eqnarray}
\]</span></p>
<p>La media y varianza iniciales de <span class="math inline">\(\lambda_{j}\)</span> están dadas por <span class="math inline">\(\mu\)</span> y
<span class="math inline">\(\mu^2/\alpha\)</span>, para toda <span class="math inline">\(j\)</span>. Las llamaremos la media y varianza poblacionales
ya que son comunes para todos los hospitales.
En la segunda etapa, los hiperparámetros <span class="math inline">\(\mu\)</span> y <span class="math inline">\(\alpha\)</span> se suponen
independientes y les asignaremos iniciales vagas.
Al parámetro de media,</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    h(\mu)\propto\frac{1}{\mu}, \mu&gt;0.
\end{eqnarray}
\]</span>
Al parámetro de precisión <span class="math inline">\(\alpha\)</span> le asignamos una densidad inicial propia pero
plana, de la forma,
<span class="math display">\[
\begin{eqnarray}
    \nonumber
    h(\alpha)=\frac{z_{0}}{(\alpha+z_0)^2}, \alpha&gt;0.
\end{eqnarray}
\]</span></p>
<p>El valor <span class="math inline">\(z_0\)</span> es la mediana de <span class="math inline">\(\alpha\)</span>, no contamos con información inicial de
forma que por ahora usaremos <span class="math inline">\(z_0=0.5\)</span>.</p>
<p>Debido a la estructura de independencia condicional del modelo jerárquico y a
que se eligió una inicial conjugada, el análisis posterior es relativamente
sencillo. Utilizamos el Teorema de Bayes para calcular la distribución posterior
de <span class="math inline">\(\lambda_{j}\)</span> condicional a los valores de los hiperparámetros <span class="math inline">\(\mu\)</span> y
<span class="math inline">\(\alpha\)</span>,</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    g(\lambda_{j}|y_{j},\alpha,\mu) &amp;\propto&amp; g(\lambda_{j}|\alpha,\mu)f(y_{j}|\lambda_{j})\\
    \nonumber
    &amp;=&amp; \frac{(\alpha/\mu)^{\alpha} \lambda_{j}^{\alpha-1}exp(-\lambda_{j} \alpha/\mu)}{\Gamma(\alpha)}\frac{exp(-e_{j}\lambda_{j})(e_{j}\lambda_{j})^{y_{j}}}{y_{j}!}\\
    \nonumber
    &amp;\propto&amp; \lambda_{j}^{y_{j}+\alpha-1}exp(-\lambda_{j}(e_{j}+\alpha/\mu))
\end{eqnarray}
\]</span></p>
<p>obtenemos así que las tasas <span class="math inline">\(\{\lambda_{1},..., \lambda_{94}\}\)</span> tienen
distribuciones posteriores independientes
<span class="math inline">\(Gamma(y_{j}+\alpha, e_{j}+\alpha/\mu)\)</span>, con media:</p>
<p><span class="math display">\[
\begin{eqnarray}
    E(\lambda_{j}|y,\alpha,\mu) &amp;=&amp; \frac{y_{j}+\alpha}{e_{j}+\alpha/\mu}\\
    \label{eqn:pond}
    &amp;=&amp; (1-A_{j})\frac{y_{j}}{e_{j}}+A_{j}\mu,
\end{eqnarray}
\]</span>
donde
<span class="math display">\[
\begin{eqnarray}
    \label{eqn:factor}
    A_{j}=\frac{\alpha}{\alpha+e_{j}\mu},
\end{eqnarray}
\]</span></p>
<p>Denominamos al factor <span class="math inline">\(A_{j}\)</span> como el encogimiento hacia la media poblacional
<span class="math inline">\(\mu\)</span>, más adelante derivamos la distribución posterior de <span class="math inline">\(\mu\)</span>, pero por ahora
la enunciamos con el propósito de mostrar que su distribución incorpora
información de todos los hospitales,</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    f(\mu|y)=K \int \prod_{i=1}^{94} \left[ \frac {(\alpha/\mu)^\alpha\Gamma(y_{i}+\alpha)} {(e_{i}+\alpha/\mu)^{y_{i}+\alpha}} \right ]\frac{z_{0}}{(\alpha+z_0)^2} \frac{1}{\mu} d\alpha
\end{eqnarray}
\]</span>
donde <span class="math inline">\(K\)</span> es una constante.</p>
<p>Al escribir la media posterior de <span class="math inline">\(\lambda_{j}\)</span> como un promedio ponderado,
podemos ver el efecto de unir fuerzas mencionado en las observaciones del
modelo jerárquico: hay un encogimiento hacia <span class="math inline">\(\mu\)</span> que depende del número de
expuestos, <span class="math inline">\(e_{j}\)</span>, para los hospitales con menor número de expuestos el
encogimiento hacia <span class="math inline">\(\mu\)</span> es mayor, mientras que para aquellos con mayor número
de expuestos, es más importante la tasa observada, <span class="math inline">\(y_{j}/e_{j}\)</span>. De esta
manera, mayor encogimiento corresponde a las observaciones con mayor
incertidumbre.</p>
<p>Notemos también que la factorización de la media posterior es similar a la que
obteníamos en el modelo de medias independientes. La diferencia radica en que
ahora es un sólo modelo (opuesto a <span class="math inline">\(94\)</span>), y los parámetros de la distribución
inicial de <span class="math inline">\(\lambda_{j}\)</span> forman parte del modelo de probabilidad pues les
asignamos una distribución inicial.</p>
</div>
<div id="distribuciones-posteriores" class="section level4 unnumbered">
<h4>Distribuciones posteriores</h4>
<p>Sea <span class="math inline">\(\lambda=(\lambda_{1},...,\lambda_{94})\)</span> y <span class="math inline">\(y=(y_{1},...,y_{94})\)</span>,
calculamos la densidad posterior conjunta de los parámetros,</p>
<p><span class="math display">\[
\begin{align}
    \nonumber
    f(\lambda,\alpha,\mu|y) &amp;\propto f(y|\lambda,\alpha,\mu)f(\lambda,\alpha,\mu)\\
\nonumber
    &amp;= f(y|\lambda) f(\lambda|\alpha,\mu) p(\alpha,\mu)\\
\nonumber
    &amp;= \prod_{i=1}^{94}f(y_{i}|\lambda_{i}) \prod_{i=1}^{94} f(\lambda_{i}|\alpha,\mu) f(\alpha)f(\mu)\\
\nonumber
    &amp;\propto \prod_{i=1}^{94} \frac {exp(-e_{i}\lambda_{i})(e_{i}\lambda_{i})^{y_{i}}} {y_{i}!} \prod_{i=1}^{94} \frac {(\alpha/\mu)^{\alpha}\lambda_{i}^{\alpha-1}exp(-\lambda_{i}(\alpha/\mu))} {\Gamma(\alpha)} \frac{z_{0}}{(\alpha+z_0)^2} \frac{1}{\mu}\\
    \nonumber
    &amp;\propto \prod_{i=1}^{94}\frac {(e_{i}+\alpha/\mu)^{y_{i}+\alpha}\lambda_{i}^{y_{i}+\alpha-1}exp(-\lambda_{i}(e_{i}+\alpha/\mu))} {\Gamma(y_{i}+\alpha)} \prod_{i=1}^{94}\frac {(\alpha/\mu)^\alpha\Gamma(y_{i}+\alpha)} {(e_{i}+\alpha/\mu)^{y_{i}+\alpha}}\frac{z_{0}}{(\alpha+z_0)^2} \frac{1}{\mu},
\end{align}
\]</span></p>
<p>de aquí podemos integrar las tasas de mortalidad, <span class="math inline">\(\lambda_{j}\)</span>, para obtener la
distribución posterior de los hiperparámetros <span class="math inline">\(f(\alpha,\mu|y)\)</span>,</p>
<p><span class="math display">\[
{\normalsize
\begin{align}
    \nonumber
    f(\alpha,\mu|y) \propto \int_{\lambda_{1}} ...\lambda_{y_{94}}
    \prod_{i=1}^{94}(\frac {(e_{i}+\alpha/\mu)^{y_{i}+\alpha}\lambda_{i}^{y_{i}+\alpha-1}exp(-\lambda_{i}(e_{i}+\alpha/\mu))} {\Gamma(y_{i}+\alpha)}) \prod_{i=1}^{94}k_i  d\lambda_{1}...d\lambda_{94},\\
    \nonumber
\end{align}
}
\]</span></p>
<p>donde,</p>
<p><span class="math display">\[
\normalsize{
\begin{align}
    \nonumber
    k_i = \frac {(\alpha/\mu)^\alpha\Gamma(y_{i}+\alpha)} {(e_{i}+\alpha/\mu)^{y_{i}+\alpha}}\frac{z_{0}}{(\alpha+z_0)^2} \frac{1}{\mu}
\end{align}}
\]</span></p>
<p>observemos que las <span class="math inline">\(\{k_j\}\)</span> no dependen de <span class="math inline">\(y\)</span> por lo que son constantes en la
integral, además para cada <span class="math inline">\(i\)</span> de la primera multiplicación tenemos una
distribución <span class="math inline">\(Gamma(y_{i}+\alpha, e_{i}+\alpha/\mu)\)</span> por lo que integran <span class="math inline">\(1\)</span>.</p>
<p>Resultando,</p>
<p><span class="math display">\[
{\normalsize
\begin{align}
    \nonumber
    f(\alpha,\mu|y)=K\prod_{i=1}^{94} \frac {(\alpha/\mu)^\alpha\Gamma(y_{i}+\alpha)} {(e_{i}+\alpha/\mu)^{y_{i}+\alpha}}\frac{z_{0}}{(\alpha+z_0)^2} \frac{1}{\mu}
\end{align}}
\]</span></p>
<p>donde <span class="math inline">\(K\)</span> es la constante de proporcionalidad.</p>
<p>Simulemos de las distribuciones posteriores, para ello procederemos como sigue:</p>
<ol style="list-style-type: decimal">
<li><p>Simulamos <span class="math inline">\((\mu, \alpha)\)</span> de la distribución marginal posterior.</p></li>
<li><p>Simulamos <span class="math inline">\(\lambda_1,...,\lambda_{94}\)</span> de la distribución posterior condicional
a los valores simulados <span class="math inline">\((\mu, \alpha)\)</span>.</p></li>
</ol>
<p>Para el primer paso, notamos que ambos parámetros son positivos por lo que es
conveniente transformarlos: <span class="math inline">\(\theta_1 = log(\alpha\)</span>, <span class="math inline">\(\theta_2 = log(\mu)\)</span>.</p>
<p>Definimos ahora la distribución posterior en términos de los parámetros
transformados</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb399-1" data-line-number="1"><span class="co"># código Albert paquete LearnBayes</span></a>
<a class="sourceLine" id="cb399-2" data-line-number="2">poissgamexch &lt;-<span class="st"> </span><span class="cf">function</span>(theta, datapar){ <span class="co"># theta = c(theta_1, theta_2)</span></a>
<a class="sourceLine" id="cb399-3" data-line-number="3">    y &lt;-<span class="st"> </span>datapar<span class="op">$</span>data[, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb399-4" data-line-number="4">    e &lt;-<span class="st"> </span>datapar<span class="op">$</span>data[, <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb399-5" data-line-number="5">    z0 &lt;-<span class="st"> </span>datapar<span class="op">$</span>z0</a>
<a class="sourceLine" id="cb399-6" data-line-number="6">    alpha &lt;-<span class="st"> </span><span class="kw">exp</span>(theta[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb399-7" data-line-number="7">    mu &lt;-<span class="st"> </span><span class="kw">exp</span>(theta[<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb399-8" data-line-number="8">    beta &lt;-<span class="st"> </span>alpha<span class="op">/</span>mu</a>
<a class="sourceLine" id="cb399-9" data-line-number="9">    logf &lt;-<span class="st"> </span><span class="cf">function</span>(y, e, alpha, beta){</a>
<a class="sourceLine" id="cb399-10" data-line-number="10">        <span class="kw">lgamma</span>(alpha <span class="op">+</span><span class="st"> </span>y) <span class="op">-</span><span class="st"> </span>(y <span class="op">+</span><span class="st"> </span>alpha) <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(e <span class="op">+</span><span class="st"> </span>beta) <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(beta) <span class="op">-</span><span class="st"> </span></a>
<a class="sourceLine" id="cb399-11" data-line-number="11"><span class="st">            </span><span class="kw">lgamma</span>(alpha)</a>
<a class="sourceLine" id="cb399-12" data-line-number="12">    }</a>
<a class="sourceLine" id="cb399-13" data-line-number="13">    val &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">logf</span>(y, e, alpha, beta))</a>
<a class="sourceLine" id="cb399-14" data-line-number="14">    val &lt;-<span class="st"> </span>val <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(alpha) <span class="op">-</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(alpha <span class="op">+</span><span class="st"> </span>z0)</a>
<a class="sourceLine" id="cb399-15" data-line-number="15">    val</a>
<a class="sourceLine" id="cb399-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb399-17" data-line-number="17"><span class="co"># Simulamos theta_1, theta_2 usando el algoritmo de Metropolis dentro de Gibbs</span></a>
<a class="sourceLine" id="cb399-18" data-line-number="18"><span class="co"># en la función gibbs, datapar contiene la base de datos y el valor del </span></a>
<a class="sourceLine" id="cb399-19" data-line-number="19"><span class="co"># hiperparámetro z0 </span></a>
<a class="sourceLine" id="cb399-20" data-line-number="20">datapar &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">data =</span> hearttransplants, <span class="dt">z0 =</span> <span class="fl">0.53</span>)</a>
<a class="sourceLine" id="cb399-21" data-line-number="21"><span class="co"># adicionalmente debemos dar valores para el algoritmo Metrópolis, la función </span></a>
<a class="sourceLine" id="cb399-22" data-line-number="22"><span class="co"># implementa un algoritmo de caminata aleatoria</span></a>
<a class="sourceLine" id="cb399-23" data-line-number="23"><span class="co"># donde la distribución propuesta tiene la forma  theta* = theta^t-1 + scale*Z</span></a>
<a class="sourceLine" id="cb399-24" data-line-number="24"><span class="co"># y Z es N(0, I), en este caso c(1, 0.15) es el vector de escala</span></a>
<a class="sourceLine" id="cb399-25" data-line-number="25">fitgibbs &lt;-<span class="st"> </span><span class="kw">gibbs</span>(poissgamexch, <span class="dt">start =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">-7</span>), <span class="dt">m =</span> <span class="dv">1000</span>, <span class="dt">scale =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.15</span>),</a>
<a class="sourceLine" id="cb399-26" data-line-number="26">    datapar)</a>
<a class="sourceLine" id="cb399-27" data-line-number="27">fitgibbs<span class="op">$</span>accept</a>
<a class="sourceLine" id="cb399-28" data-line-number="28"><span class="co">#&gt;       [,1]  [,2]</span></a>
<a class="sourceLine" id="cb399-29" data-line-number="29"><span class="co">#&gt; [1,] 0.511 0.508</span></a>
<a class="sourceLine" id="cb399-30" data-line-number="30"><span class="co"># simulaciones de alpha</span></a>
<a class="sourceLine" id="cb399-31" data-line-number="31">alpha &lt;-<span class="st"> </span><span class="kw">exp</span>(fitgibbs<span class="op">$</span>par[, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb399-32" data-line-number="32"><span class="co"># simulaciones de mu</span></a>
<a class="sourceLine" id="cb399-33" data-line-number="33">mu &lt;-<span class="st"> </span><span class="kw">exp</span>(fitgibbs<span class="op">$</span>par[, <span class="dv">2</span>])</a></code></pre></div>
<p>Podemos usar las simulaciones de <span class="math inline">\(\alpha\)</span> y <span class="math inline">\(\mu\)</span> para ver el encogimiento de
las estimaciones de cada hosiptal hacia la media poblacional. Notamos un mayor
encogimiento para los hospitales con menor número de expuestos.</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb400-1" data-line-number="1">heart_jer &lt;-<span class="st"> </span>heart <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb400-2" data-line-number="2"><span class="st">    </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb400-3" data-line-number="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">A =</span> <span class="kw">mean</span>(alpha <span class="op">/</span><span class="st"> </span>(alpha <span class="op">+</span><span class="st"> </span>e <span class="op">*</span><span class="st"> </span>mu)))</a>
<a class="sourceLine" id="cb400-4" data-line-number="4"><span class="kw">ggplot</span>(heart_jer, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> A)) <span class="op">+</span></a>
<a class="sourceLine" id="cb400-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.6</span>, <span class="dt">size =</span> <span class="fl">1.6</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb400-6" data-line-number="6"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Número de expuestos (e)&quot;</span>, <span class="dt">label =</span> exp, </a>
<a class="sourceLine" id="cb400-7" data-line-number="7">        <span class="dt">breaks =</span> <span class="kw">map_dbl</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">700</span> <span class="op">^</span><span class="st"> </span>.))) <span class="op">+</span></a>
<a class="sourceLine" id="cb400-8" data-line-number="8"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;encogimiento (A)&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb400-9" data-line-number="9"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-79-1.png" width="400px" style="display: block; margin: auto;" /></p>
<p>Ahora simualmos observaciones de la distribución posterior de <span class="math inline">\(\lambda\)</span>:</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb401-1" data-line-number="1">heart_jer_sims &lt;-<span class="st"> </span>heart_jer <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb401-2" data-line-number="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sims =</span> <span class="kw">map2</span>(e, y, <span class="op">~</span><span class="kw">rgamma</span>(<span class="dv">1000</span>, .y <span class="op">+</span><span class="st"> </span>alpha, .x <span class="op">+</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span>mu))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb401-3" data-line-number="3"><span class="st">    </span><span class="kw">ungroup</span>()</a></code></pre></div>
<p>Ya que tenemos las distribuciones posteriores podemos hacer inferencia acerca de
la tasa de mortalidad <span class="math inline">\(\lambda\)</span>. A continuación graficamos los intervalos
posteriores del <span class="math inline">\(95\%\)</span> de probabilidad para las tasas <span class="math inline">\(\lambda_{j}\)</span>, el color
representa el número de muertes observadas <span class="math inline">\(y_{j}\)</span>, en gris se graficaron las
tasas observadas, la gráfica se dividió en <span class="math inline">\(3\)</span> páneles de acuerdo al número de
muertes observadas en los hospitales.</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb402-1" data-line-number="1"><span class="co"># Creamos intervalos con las simulaciones</span></a>
<a class="sourceLine" id="cb402-2" data-line-number="2">heart_jer_post &lt;-<span class="st"> </span>heart_jer_sims <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb402-3" data-line-number="3"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb402-4" data-line-number="4">        <span class="dt">media =</span> <span class="kw">map_dbl</span>(sims, <span class="op">~</span><span class="kw">mean</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>.)), </a>
<a class="sourceLine" id="cb402-5" data-line-number="5">        <span class="dt">int_l =</span> <span class="kw">map_dbl</span>(sims, <span class="op">~</span><span class="kw">quantile</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>., <span class="fl">0.025</span>)), </a>
<a class="sourceLine" id="cb402-6" data-line-number="6">        <span class="dt">int_u =</span> <span class="kw">map_dbl</span>(sims, <span class="op">~</span><span class="kw">quantile</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>., <span class="fl">0.975</span>)),</a>
<a class="sourceLine" id="cb402-7" data-line-number="7">        <span class="dt">sims_y =</span> <span class="kw">map2</span>(sims, e, <span class="op">~</span><span class="kw">rpois</span>(<span class="dv">1000</span>, .x <span class="op">*</span><span class="st"> </span>.y))</a>
<a class="sourceLine" id="cb402-8" data-line-number="8">        )</a>
<a class="sourceLine" id="cb402-9" data-line-number="9"></a>
<a class="sourceLine" id="cb402-10" data-line-number="10"><span class="kw">ggplot</span>(heart_jer_post, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> media, <span class="dt">color =</span> <span class="kw">factor</span>(y))) <span class="op">+</span></a>
<a class="sourceLine" id="cb402-11" data-line-number="11"><span class="st">    </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> int_l, <span class="dt">ymax =</span> int_u), <span class="dt">size =</span> <span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb402-12" data-line-number="12"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data =</span> heart, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> <span class="dv">1000</span> <span class="op">*</span><span class="st"> </span>y <span class="op">/</span><span class="st"> </span>e), <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, </a>
<a class="sourceLine" id="cb402-13" data-line-number="13">        <span class="dt">alpha =</span> <span class="fl">0.6</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb402-14" data-line-number="14"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Número de expuestos (e)&quot;</span>, <span class="dt">labels =</span> exp, </a>
<a class="sourceLine" id="cb402-15" data-line-number="15">        <span class="dt">breaks =</span> <span class="kw">map_dbl</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">700</span> <span class="op">^</span><span class="st"> </span>.))) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb402-16" data-line-number="16"><span class="st">    </span><span class="kw">scale_colour_hue</span>(<span class="st">&quot;muertes obs. (y)&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb402-17" data-line-number="17"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Muertes por 1000 expuestos&quot;</span>)</a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-81-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Analizamos la distribución predictiva posterior para la misma muestra de <span class="math inline">\(10\)</span>
hospitales que se utilizó en el modelo de unidades iguales.</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb403-1" data-line-number="1">sims_muestra &lt;-<span class="st"> </span>heart_jer_post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb403-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(hospital <span class="op">%in%</span><span class="st"> </span>heart_sims_sample<span class="op">$</span>hospital)</a>
<a class="sourceLine" id="cb403-3" data-line-number="3">sims_unnest &lt;-<span class="st"> </span>sims_muestra <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb403-4" data-line-number="4"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">select</span>(hospital, e, y, sims_y) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb403-5" data-line-number="5"><span class="st">    </span><span class="kw">unnest</span>(<span class="dt">cols =</span> sims_y)</a>
<a class="sourceLine" id="cb403-6" data-line-number="6"></a>
<a class="sourceLine" id="cb403-7" data-line-number="7"><span class="kw">ggplot</span>(sims_unnest, <span class="kw">aes</span>(<span class="dt">x =</span> sims_y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb403-8" data-line-number="8"><span class="st">    </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">y =</span> ..density..), <span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;darkgray&quot;</span>, </a>
<a class="sourceLine" id="cb403-9" data-line-number="9">        <span class="dt">fill =</span> <span class="st">&quot;darkgray&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb403-10" data-line-number="10"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>hospital, <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb403-11" data-line-number="11"><span class="st">    </span><span class="kw">geom_segment</span>(<span class="dt">data =</span> sims_muestra, <span class="kw">aes</span>(<span class="dt">x =</span> y, <span class="dt">xend =</span> y, <span class="dt">y =</span> <span class="dv">0</span>, <span class="dt">yend =</span> <span class="fl">0.5</span>), </a>
<a class="sourceLine" id="cb403-12" data-line-number="12">        <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb403-13" data-line-number="13"><span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">data =</span> sims_muestra, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">10</span>, <span class="dt">y =</span> <span class="fl">0.4</span>, <span class="dt">label =</span> <span class="kw">paste</span>(<span class="st">&quot;e =&quot;</span>, e)), </a>
<a class="sourceLine" id="cb403-14" data-line-number="14">        <span class="dt">size =</span> <span class="fl">2.7</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>)</a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-82-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>Observemos que únicamente en uno de los histogramas el número de muertes
observadas se encuentra cerca de la cola de la distribución, lo que indica
concordancia de las observaciones con el modelo ajustado.</p>
<p>Finalmente, revisamos la consistencia de los valores observados <span class="math inline">\(y_{j}\)</span> con la
distribución predictiva posterior para todos los hospitales, para ello
calculamos la probabilidad de que una observación futura <span class="math inline">\(y_{j}^*\)</span> sea al menos
tan extrema como <span class="math inline">\(y_{j}\)</span> para todas las observaciones:</p>
<p><span class="math display">\[
\begin{eqnarray}
    \nonumber
    P(extremos) = min\{P(y_{j}^*\leq y_{j}),P(y_{j}^*\geq y_{j})\}
\end{eqnarray}
\]</span></p>
<p>A continuación graficamos las probabilidades de extremos (calculadas con
simulación). Con el modelo jerárquico solamente el <span class="math inline">\(6\%\)</span> de las probabilidades son
menores al <span class="math inline">\(0.15\)</span>, una disminución considerable al <span class="math inline">\(28\%\)</span> obtenido con el modelo de
unidades iguales.</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb404-1" data-line-number="1"><span class="co"># Para calcular las p predictiva podemos usar las simulaciones</span></a>
<a class="sourceLine" id="cb404-2" data-line-number="2">p_pred &lt;-<span class="st"> </span>heart_sims <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-3" data-line-number="3"><span class="st">    </span><span class="kw">unnest</span>(<span class="dt">cols =</span> sims) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-4" data-line-number="4"><span class="st">    </span><span class="kw">group_by</span>(hospital) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-5" data-line-number="5"><span class="st">    </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb404-6" data-line-number="6">        <span class="dt">p =</span> <span class="kw">min</span>(<span class="kw">sum</span>(sims <span class="op">&lt;=</span><span class="st"> </span>y) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>, <span class="kw">sum</span>(sims <span class="op">&gt;=</span><span class="st"> </span>y) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>), </a>
<a class="sourceLine" id="cb404-7" data-line-number="7">        <span class="dt">e =</span> <span class="kw">first</span>(e)</a>
<a class="sourceLine" id="cb404-8" data-line-number="8">        )</a>
<a class="sourceLine" id="cb404-9" data-line-number="9">p_pred_indep_jer &lt;-<span class="st"> </span>heart_jer_post <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-10" data-line-number="10"><span class="st">    </span><span class="kw">unnest</span>(<span class="dt">cols =</span> <span class="kw">c</span>(sims, sims_y)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-11" data-line-number="11"><span class="st">    </span><span class="kw">group_by</span>(hospital) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-12" data-line-number="12"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">p_jer =</span> <span class="kw">min</span>(<span class="kw">sum</span>(sims_y <span class="op">&lt;=</span><span class="st"> </span>y) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>, <span class="kw">sum</span>(sims_y <span class="op">&gt;=</span><span class="st"> </span>y) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-13" data-line-number="13"><span class="st">    </span><span class="kw">left_join</span>(p_pred, <span class="dt">by =</span> <span class="st">&quot;hospital&quot;</span>)</a>
<a class="sourceLine" id="cb404-14" data-line-number="14"></a>
<a class="sourceLine" id="cb404-15" data-line-number="15"><span class="kw">ggplot</span>(p_pred_indep_jer, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> p_jer)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-16" data-line-number="16"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb404-17" data-line-number="17"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Número de expuestos (e)&quot;</span>, <span class="dt">labels =</span> exp, </a>
<a class="sourceLine" id="cb404-18" data-line-number="18">        <span class="dt">breaks =</span> <span class="kw">map_dbl</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">700</span> <span class="op">^</span><span class="st"> </span>.))) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb404-19" data-line-number="19"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;P(extremos)&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb404-20" data-line-number="20"><span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">.15</span>, <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb404-21" data-line-number="21"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">.7</span>) </a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-83-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>Comparemos ahora las probabilidades de al menos tan extremo usando el modelo
jerárquico contra las probabilidades de al menos tan extremo usando el modelo de
unidades iguales, los puntos se colorearon de acuerdo al número de expuestos de
cada hospital. Observemos que las probabilidades bajo el modelo jerárquico son
mayores en la mayoría de los casos.</p>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb405-1" data-line-number="1">p_pred_indep_jer &lt;-<span class="st"> </span>p_pred_indep_jer <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb405-2" data-line-number="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">e_cat =</span>  Hmisc<span class="op">::</span><span class="kw">cut2</span>(e, <span class="kw">c</span>(<span class="dv">500</span>, <span class="dv">1500</span>, <span class="dv">2500</span>, <span class="dv">4000</span>, <span class="dv">12500</span>)))</a>
<a class="sourceLine" id="cb405-3" data-line-number="3"><span class="kw">ggplot</span>(p_pred_indep_jer, <span class="kw">aes</span>(<span class="dt">x =</span> p, <span class="dt">y =</span> p_jer, <span class="dt">colour =</span> e_cat)) <span class="op">+</span></a>
<a class="sourceLine" id="cb405-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_abline</span>(<span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="fl">0.4</span>, <span class="dt">alpha =</span> <span class="fl">0.8</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb405-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">2.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb405-6" data-line-number="6"><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;P(extremos), unidades iguales&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb405-7" data-line-number="7"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;P(extremos), jerárquico&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb405-8" data-line-number="8"><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="fl">0.7</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb405-9" data-line-number="9"><span class="st">    </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="fl">0.7</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb405-10" data-line-number="10"><span class="st">    </span><span class="kw">coord_equal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb405-11" data-line-number="11"><span class="st">    </span><span class="kw">scale_colour_manual</span>(<span class="st">&quot;No. expuestos (e)&quot;</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#a6cee3&quot;</span>, <span class="st">&quot;#1f78b4&quot;</span>,</a>
<a class="sourceLine" id="cb405-12" data-line-number="12">        <span class="st">&quot;#b2df8a&quot;</span>, <span class="st">&quot;#33a02c&quot;</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>()</a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-84-1.png" width="400px" style="display: block; margin: auto;" /></p>
</div>
<div id="stan-2" class="section level4 unnumbered">
<h4>Stan</h4>
<p>Ahora veremos como hacer la estimación usando Stan. Primero hacemos un par de
cambios en la definición del modelo, esto es porque la distribución inicial de
<span class="math inline">\(\mu\)</span> no es propia (i.e. no integra uno) y preferimos un ejemplo con iniciales
propia, usaremos una <span class="math inline">\(Gamma\)</span> para <span class="math inline">\(\alpha\)</span> y <span class="math inline">\(\mu\)</span> eligiendo parámetros
de manera que sean iniciales vagas.</p>
<p><span class="math display">\[\mu, \alpha \sim Gamma(0.01, 0.01).\]</span></p>
<div class="sourceCode" id="cb406"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb406-1" data-line-number="1">modelo_heart.stan &lt;-</a>
<a class="sourceLine" id="cb406-2" data-line-number="2"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb406-3" data-line-number="3"><span class="st">data {</span></a>
<a class="sourceLine" id="cb406-4" data-line-number="4"><span class="st">    int N;</span></a>
<a class="sourceLine" id="cb406-5" data-line-number="5"><span class="st">    vector&lt;lower=0&gt;[N] e;</span></a>
<a class="sourceLine" id="cb406-6" data-line-number="6"><span class="st">    int y[N];</span></a>
<a class="sourceLine" id="cb406-7" data-line-number="7"><span class="st">}</span></a>
<a class="sourceLine" id="cb406-8" data-line-number="8"><span class="st">parameters {</span></a>
<a class="sourceLine" id="cb406-9" data-line-number="9"><span class="st">    vector&lt;lower=0, upper=1&gt;[N] lambda;</span></a>
<a class="sourceLine" id="cb406-10" data-line-number="10"><span class="st">    real&lt;lower=0&gt; mu;</span></a>
<a class="sourceLine" id="cb406-11" data-line-number="11"><span class="st">    real&lt;lower=0&gt; alpha;</span></a>
<a class="sourceLine" id="cb406-12" data-line-number="12"><span class="st">}</span></a>
<a class="sourceLine" id="cb406-13" data-line-number="13"><span class="st">model {</span></a>
<a class="sourceLine" id="cb406-14" data-line-number="14"><span class="st">    lambda ~ gamma(alpha, alpha/ mu);</span></a>
<a class="sourceLine" id="cb406-15" data-line-number="15"><span class="st">    y ~ poisson(lambda .* e);</span></a>
<a class="sourceLine" id="cb406-16" data-line-number="16"><span class="st">    mu ~ normal(0, 1);</span></a>
<a class="sourceLine" id="cb406-17" data-line-number="17"><span class="st">    alpha ~ normal(0, 10);</span></a>
<a class="sourceLine" id="cb406-18" data-line-number="18"><span class="st">}</span></a>
<a class="sourceLine" id="cb406-19" data-line-number="19"></a>
<a class="sourceLine" id="cb406-20" data-line-number="20"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb406-21" data-line-number="21"><span class="kw">cat</span>(<span class="dt">file =</span> <span class="st">&quot;src/stan_files/modelo_heart.stan&quot;</span>, modelo_heart.stan)</a>
<a class="sourceLine" id="cb406-22" data-line-number="22">stan_heart_cpp &lt;-<span class="st"> </span><span class="kw">stan_model</span>(<span class="st">&quot;src/stan_files/modelo_heart.stan&quot;</span>)</a>
<a class="sourceLine" id="cb406-23" data-line-number="23"></a>
<a class="sourceLine" id="cb406-24" data-line-number="24"><span class="co"># creamos una lista con los datos: esta incluye índices, y variables</span></a>
<a class="sourceLine" id="cb406-25" data-line-number="25">heart_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">e =</span> heart<span class="op">$</span>e, <span class="dt">y =</span> heart<span class="op">$</span>y, <span class="dt">N =</span> <span class="kw">nrow</span>(heart))</a>
<a class="sourceLine" id="cb406-26" data-line-number="26">stan_heart_fit &lt;-<span class="st"> </span><span class="kw">sampling</span>(stan_heart_cpp, </a>
<a class="sourceLine" id="cb406-27" data-line-number="27">    <span class="dt">data =</span> heart_data, <span class="dt">chains =</span> <span class="dv">3</span>, <span class="dt">cores =</span> <span class="dv">3</span>, <span class="dt">iter =</span> <span class="dv">4000</span>)</a>
<a class="sourceLine" id="cb406-28" data-line-number="28"></a>
<a class="sourceLine" id="cb406-29" data-line-number="29"><span class="co"># shinystan::launch_shinystan(stan_heart_fit)</span></a></code></pre></div>
<p>En el modelo definimos una distribución de probabilidad para cada hospital, las
tasas de mortalidad se modelan como observaciones de una distribución
<span class="math inline">\(Gamma(\alpha, \alpha/\mu)\)</span>, y especificamos la distribución de los
hiperparámetros.</p>
<p>Repetimos la gráfica de intervalos posteriores para <span class="math inline">\(\lambda_j\)</span> (expresada por
1000 expuestos) y tasas observadas.</p>
<div class="sourceCode" id="cb407"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb407-1" data-line-number="1">sims_lambda &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(stan_heart_fit, <span class="dt">pars =</span> <span class="st">&quot;lambda&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb407-2" data-line-number="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">n_sim =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb407-3" data-line-number="3"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="op">-</span>n_sim, <span class="dt">names_to =</span> <span class="st">&quot;hospital&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;lambda&quot;</span>,</a>
<a class="sourceLine" id="cb407-4" data-line-number="4">        <span class="dt">names_prefix =</span> <span class="st">&quot;lambda&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb407-5" data-line-number="5"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">hospital =</span> <span class="kw">parse_number</span>(hospital)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb407-6" data-line-number="6"><span class="st">    </span><span class="kw">group_by</span>(hospital) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb407-7" data-line-number="7"><span class="st">    </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb407-8" data-line-number="8">        <span class="dt">media =</span> <span class="kw">mean</span>(lambda), </a>
<a class="sourceLine" id="cb407-9" data-line-number="9">        <span class="dt">int_l =</span> <span class="kw">quantile</span>(lambda, <span class="fl">0.025</span>),</a>
<a class="sourceLine" id="cb407-10" data-line-number="10">        <span class="dt">int_u =</span> <span class="kw">quantile</span>(lambda, <span class="fl">0.975</span>)</a>
<a class="sourceLine" id="cb407-11" data-line-number="11">        ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb407-12" data-line-number="12"><span class="st">    </span><span class="kw">left_join</span>(heart, <span class="dt">by =</span> <span class="st">&quot;hospital&quot;</span>)</a>
<a class="sourceLine" id="cb407-13" data-line-number="13"></a>
<a class="sourceLine" id="cb407-14" data-line-number="14"><span class="kw">ggplot</span>(sims_lambda, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> media <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>, <span class="dt">color =</span> <span class="kw">factor</span>(y))) <span class="op">+</span></a>
<a class="sourceLine" id="cb407-15" data-line-number="15"><span class="st">    </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> int_l <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>, <span class="dt">ymax =</span> int_u <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>), <span class="dt">size =</span> <span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb407-16" data-line-number="16"><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log</span>(e), <span class="dt">y =</span> y<span class="op">/</span>e<span class="op">*</span><span class="dv">1000</span>), <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.6</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb407-17" data-line-number="17"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Número de expuestos (e)&quot;</span>, <span class="dt">labels =</span> exp, </a>
<a class="sourceLine" id="cb407-18" data-line-number="18">        <span class="dt">breaks =</span> <span class="kw">map_dbl</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">700</span> <span class="op">^</span><span class="st"> </span>.))) <span class="op">+</span></a>
<a class="sourceLine" id="cb407-19" data-line-number="19"><span class="st">    </span><span class="kw">scale_colour_hue</span>(<span class="st">&quot;muertes obs. (y)&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb407-20" data-line-number="20"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Muertes por 1000 expuestos&quot;</span>)</a></code></pre></div>
<p><img src="09-analisis_bayesiano_files/figure-html/unnamed-chunk-86-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<h3>Referencias</h3>
<div id="refs" class="references">
<div id="ref-albert">
<p>Albert, J. 2009. <em>Bayesian Computation with R</em>. Use R! Springer New York. <a href="https://books.google.com.mx/books?id=AALhk\_mt7SYC" class="uri">https://books.google.com.mx/books?id=AALhk\_mt7SYC</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="diagnósticos-generales.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="inicialesy-reparametrización.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tereom/est-computacional-2019/edit/master/09-analisis_bayesiano.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
